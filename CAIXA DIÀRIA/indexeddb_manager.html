<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Manager üõ†Ô∏è</title>
    <style>
        /* Dise√±o Moderno y Profesional */
        :root {
            --primary: #3b82f6;
            --secondary: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f9fafb;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); margin: 0; color: #1f2937; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* Encabezado */
        h1 { color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-top: 0; font-size: 1.8rem; }

        /* Pesta√±as de Navegaci√≥n */
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.2s;
        }
        .tab-button:hover { color: #374151; }
        .tab-button.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        .tab-content { padding: 15px 0; background: var(--card-bg); border-radius: 6px; box-shadow: var(--shadow); padding: 20px; }
        
        /* Controles de Formulario/Tabla */
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: #4b5563; }

        /* Tabla de Datos */
        #dataViewerTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #dataViewerTable th, #dataViewerTable td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: left;
            font-size: 0.9rem;
            vertical-align: top;
        }
        #dataViewerTable th { background-color: var(--bg); font-weight: 600; color: var(--secondary); }
        .data-row:nth-child(even) { background-color: #f3f4f6; }
        .key-column { font-weight: bold; color: var(--primary); width: 80px; }
        .json-data-cell pre { white-space: pre-wrap; margin: 0; max-height: 100px; overflow-y: auto; font-size: 0.8rem; }

        /* Consola y Mensajes */
        .console { margin-top: 20px; padding: 15px; background: #1f2937; color: #f9fafb; border-radius: 4px; font-family: monospace; font-size: 0.9rem; }
        .message-success { color: var(--success); }
        .message-error { color: var(--danger); }
        
        /* Layout de la Pesta√±a de Datos */
        .data-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .data-controls > div { flex-grow: 1; }

        /* Alerta */
        .alert { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-weight: 500; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        /* Estilos espec√≠ficos para Formulario CRUD */
        #crudForm label, #cajaFormContent label { display: block; font-weight: 600; margin-top: 10px; }
        #crudForm textarea, #cajaFormContent textarea { min-height: 150px; }

        /* Grid para formulario estructurado */
        #cajaFormContent .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        @media (max-width: 768px) { #cajaFormContent .form-grid { grid-template-columns: 1fr; } }
        
        #cajaFormContent h3 { color: var(--primary); border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>IndexedDB Manager üõ†Ô∏è</h1>
    
    <div class="tabs">
        <button class="tab-button active" onclick="showTab('dashboard')">üè† Bases de Datos</button>
        <button class="tab-button" onclick="showTab('viewer')">üëÅÔ∏è Visualizar y CRUD</button>
        <button class="tab-button" id="cajaFormTab" onclick="showTab('cajaForm')" style="display:none;">üí∞ Caja Diaria - Formulario</button>
        <button class="tab-button" onclick="showTab('admin')">‚öôÔ∏è Admin DB/Tablas</button>
        <button class="tab-button" onclick="showTab('io')">üì• Exportar/Importar</button>
    </div>

    <div id="dashboard" class="tab-content">
        <h2>Bases de Datos Locales</h2>
        <div id="dbList" class="alert alert-warning">Cargando bases de datos...</div>
    </div>
    
    <div id="viewer" class="tab-content" style="display:none;">
        <h2>Visualizar Almacenes (Tablas)</h2>
        <div class="data-controls">
            <div>
                <label for="selectDbViewer">Seleccionar Base de Datos</label>
                <select id="selectDbViewer" onchange="loadObjectStores('viewer')">
                    <option value="">-- Seleccione DB --</option>
                </select>
            </div>
            <div>
                <label for="selectStoreViewer">Seleccionar Almac√©n (Tabla)</label>
                <select id="selectStoreViewer" onchange="viewData()">
                    <option value="">-- Seleccione Tabla --</option>
                </select>
            </div>
        </div>
        
        <h3>Datos del Almac√©n</h3>
        <button class="btn-success" id="btnInsertGeneric" onclick="toggleCrudForm('insert')">‚ûï Insertar Nuevo Registro (JSON)</button>
        <table id="dataViewerTable">
            <thead></thead>
            <tbody>
                <tr><td colspan="3">Seleccione una DB y un Almac√©n para ver los datos.</td></tr>
            </tbody>
        </table>

        <div id="crudFormContainer" style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px; display: none;">
            <h3><span id="crudModeTitle">Insertar</span> Registro (JSON)</h3>
            <form id="crudForm">
                <input type="hidden" id="crudRecordKey">
                
                <label for="crudJsonData">Datos del Registro (Formato JSON):</label>
                <textarea id="crudJsonData" placeholder='Ejemplo: {"nombre": "Juan", "edad": 30}'></textarea>
                
                <button type="button" class="btn-primary" onclick="saveCrudRecord()">Guardar</button>
                <button type="button" class="btn-secondary" onclick="document.getElementById('crudFormContainer').style.display='none'">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="cajaForm" class="tab-content" style="display:none;">
        <h2>üí∞ Formulario de Cierre de Caja Diaria</h2>
        <div class="alert alert-warning">
            Esta pesta√±a solo funciona con la Base de Datos: **CajaDiariaDB** y la Tabla: **cierres**.
        </div>
        
        <form id="cajaFormContent">
            <input type="hidden" id="cajaRecordKey">
            <input type="hidden" id="cajaMode">
            
            <h3 id="cajaFormTitle">Insertar Nuevo Cierre</h3>

            <label for="cajaDate">Fecha del Cierre (dd/mm/aaaa)</label>
            <input type="text" id="cajaDate" placeholder="Ej: 15/12/2025" value="">

            <div class="form-grid">
                <div>
                    <h3>1. Totales Generales</h3>
                    <label for="cajaTpv">TPV Registro (M√°quina)</label>
                    <input type="number" id="cajaTpv" step="0.01" value="0.00">
                    
                    <label for="cajaFondoAnterior">Fondo Caja Anterior (‚Ç¨)</label>
                    <input type="number" id="cajaFondoAnterior" step="0.01" value="0.00">

                    <label for="cajaContenidoTotal">Contenido Caja HOY (‚Ç¨)</label>
                    <input type="number" id="cajaContenidoTotal" step="0.01" value="0.00">
                </div>
                <div>
                    <h3>2. Caja Manual (Libro)</h3>
                    <label for="cajaManEfec">Total Efectivo Manual</label>
                    <input type="number" id="cajaManEfec" step="0.01" value="0.00">
                    
                    <label for="cajaManTarj">Total Tarjeta Manual</label>
                    <input type="number" id="cajaManTarj" step="0.01" value="0.00">
                </div>
                <div>
                    <h3>3. Caja Ordenador</h3>
                    <label for="cajaOrdEfec">Total Efectivo Ordenador</label>
                    <input type="number" id="cajaOrdEfec" step="0.01" value="0.00">
                    
                    <label for="cajaOrdTarj">Total Tarjeta Ordenador</label>
                    <input type="number" id="cajaOrdTarj" step="0.01" value="0.00">
                </div>
            </div>
            
            <label for="cajaRegEfecGral">Efectivo Generado (Contenido - Anterior)</label>
            <input type="number" id="cajaRegEfecGral" step="0.01" value="0.00" disabled style="background-color: #f3f4f6;">

            <label for="cajaObservaciones">üìù Observaciones</label>
            <textarea id="cajaObservaciones"></textarea>

            <button type="button" class="btn-primary" onclick="saveCajaRecord()">Guardar Cierre</button>
            <button type="button" class="btn-secondary" onclick="showTab('viewer')">Volver a Visualizar</button>
        </form>
    </div>

    <div id="admin" class="tab-content" style="display:none;">
        <h2>Gesti√≥n de Base de Datos y Almacenes</h2>
        
        <h3>Gestionar Base de Datos</h3>
        <input type="text" id="dbNameAdmin" placeholder="Nombre de la Base de Datos (Ej: MiDB)">
        <button class="btn-primary" onclick="createDatabase()">Crear DB (v1)</button>
        <button class="btn-danger" onclick="deleteDatabase()">Eliminar DB</button>
        
        <h3 style="margin-top: 20px;">Gestionar Almacenes (Tablas)</h3>
        <div class="data-controls">
            <div>
                <label for="selectDbAdmin">Seleccionar DB para Almacenes</label>
                <select id="selectDbAdmin" onchange="loadObjectStores('admin')">
                    <option value="">-- Seleccione DB --</option>
                </select>
            </div>
            <div>
                <label for="storeNameAdmin">Nombre del Nuevo Almac√©n (Tabla)</label>
                <input type="text" id="storeNameAdmin" placeholder="Ej: Clientes">
            </div>
        </div>
        <input type="text" id="keyPathAdmin" placeholder="Campo de Clave Primaria (Opcional, Ej: id)">
        <button class="btn-success" onclick="createObjectStore()">Crear Almac√©n (Tabla)</button>
        <button class="btn-danger" onclick="deleteObjectStore()">Eliminar Almac√©n</button>
    </div>

    <div id="io" class="tab-content" style="display:none;">
        <h2>Exportar e Importar Datos</h2>
        
        <h3>üì• Importar Datos (JSON)</h3>
        <div class="data-controls">
             <div>
                <label for="selectDbImport">Seleccionar Base de Datos</label>
                <select id="selectDbImport" onchange="loadObjectStores('io')">
                    <option value="">-- Seleccione DB --</option>
                </select>
            </div>
            <div>
                <label for="selectStoreImport">Seleccionar Almac√©n (Tabla)</label>
                <select id="selectStoreImport">
                    <option value="">-- Seleccione Tabla --</option>
                </select>
            </div>
        </div>
        <textarea id="importJsonData" placeholder="Pegue los datos JSON aqu√≠. Ej: [ { clave: 1, ... }, { clave: 2, ... } ]"></textarea>
        <button class="btn-primary" onclick="importData()">Importar Datos</button>
        
        <h3 style="margin-top: 20px;">üì§ Exportar Datos (JSON)</h3>
        <div class="data-controls">
            <div>
                <label for="selectDbExport">Seleccionar Base de Datos</label>
                <select id="selectDbExport" onchange="loadObjectStores('export')">
                    <option value="">-- Seleccione DB --</option>
                </select>
            </div>
            <div>
                <label for="selectStoreExport">Seleccionar Almac√©n (Tabla)</label>
                <select id="selectStoreExport">
                    <option value="">-- Seleccione Tabla --</option>
                </select>
            </div>
        </div>
        <button class="btn-primary" onclick="exportData()">Exportar a JSON</button>
        
        <h3 style="margin-top: 20px;">Exportar Base de Datos Completa</h3>
        <button class="btn-secondary" onclick="exportDatabase()">Exportar DB Completa (Todas las tablas)</button>
    </div>

    <div class="console">
        ** CONSOLA DE REGISTRO **<br>
        <span id="consoleOutput">Listo.</span>
    </div>

</div>

<script>
    // =======================================================
    // VARIABLES Y UTILIDADES
    // =======================================================
    const CONSOLE = document.getElementById('consoleOutput');
    const CAJA_DB_NAME = 'CajaDiariaDB';
    const CAJA_STORE_NAME = 'cierres';
    const dbRefs = {}; 
    const DB_VERSION = 1;

    function log(message, type = 'info') {
        let className = '';
        if (type === 'success') className = 'message-success';
        if (type === 'error') className = 'message-error';
        
        const timestamp = new Date().toLocaleTimeString('es-ES');
        CONSOLE.innerHTML = `<span class="${className}">[${timestamp}] ${message}</span><br>` + CONSOLE.innerHTML;
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).style.display = 'block';
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

        // Acciones espec√≠ficas al cambiar de pesta√±a
        if (tabId === 'dashboard') listDatabases();
        if (tabId === 'admin' || tabId === 'viewer' || tabId === 'io') populateDbSelectors();
        
        log(`Cambiando a pesta√±a: ${tabId}`);
    }

    function openDB(dbName, version = DB_VERSION) {
        return new Promise((resolve, reject) => {
            if (dbRefs[dbName]) {
                resolve(dbRefs[dbName]);
                return;
            }

            const request = indexedDB.open(dbName, version);
            
            request.onerror = (event) => {
                log(`Error al abrir DB ${dbName}: ${event.target.error}`, 'error');
                reject(event.target.error);
            };

            request.onsuccess = (event) => {
                const db = event.target.result;
                dbRefs[dbName] = db; 
                resolve(db);
            };

            request.onupgradeneeded = (event) => {
                log(`DB ${dbName} requiere actualizaci√≥n. Versi√≥n actual: ${event.oldVersion}.`, 'info');
            };
        });
    }

    // =======================================================
    // 1. DASHBOARD
    // =======================================================
    
    function listDatabases() {
        if (!indexedDB.databases) {
            document.getElementById('dbList').innerHTML = `<p class="alert-warning">Su navegador no soporta la funci√≥n <code>indexedDB.databases()</code>. No se puede listar autom√°ticamente. Intente abrir su DB actual (${CAJA_DB_NAME}) en la pesta√±a "Admin".</p>`;
            log('Funci√≥n indexedDB.databases() no soportada.', 'error');
            return;
        }

        indexedDB.databases().then(dbs => {
            const list = document.getElementById('dbList');
            if (dbs.length === 0) {
                list.innerHTML = `<p class="alert-warning">No se encontraron bases de datos IndexedDB.</p>`;
                return;
            }

            let html = '<ul>';
            dbs.forEach(db => {
                html += `<li><strong>${db.name}</strong> (Versi√≥n: ${db.version}) 
                         <button class="btn-secondary" onclick="populateDbSelectors('${db.name}')" style="margin-left: 10px;">Cargar en Vistas</button></li>`;
            });
            html += '</ul>';
            list.innerHTML = html;
            log(`Se encontraron ${dbs.length} bases de datos.`, 'success');
        }).catch(e => {
            document.getElementById('dbList').innerHTML = `<p class="alert-danger">Error al listar bases de datos: ${e.message}</p>`;
            log(`Error al listar DBs: ${e.message}`, 'error');
        });
    }

    // =======================================================
    // 2. VISUALIZAR Y CRUD (GEN√âRICO)
    // =======================================================

    function populateDbSelectors(dbName = '') {
        const knownDbs = [CAJA_DB_NAME];
        if (indexedDB.databases) {
            indexedDB.databases().then(dbs => {
                dbs.forEach(db => {
                    if (!knownDbs.includes(db.name)) knownDbs.push(db.name);
                });
                fillSelectors(knownDbs, dbName);
            });
        } else {
             fillSelectors(knownDbs, dbName);
        }

        function fillSelectors(dbs, selectName) {
            const selectors = [
                document.getElementById('selectDbViewer'),
                document.getElementById('selectDbAdmin'),
                document.getElementById('selectDbImport'),
                document.getElementById('selectDbExport')
            ];

            selectors.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- Seleccione DB --</option>';
                dbs.forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
                if (selectName) select.value = selectName;
                else select.value = currentVal;
            });
            // Si se seleccion√≥ una DB, cargar sus stores
            if (selectName) {
                loadObjectStores('viewer');
                loadObjectStores('admin');
                loadObjectStores('io');
                loadObjectStores('export');
            }
        }
    }

    async function loadObjectStores(context) {
        let dbSelect;
        let storeSelects = [];
        let viewStoreSelect; // Selector que necesitamos para verificar si se activa el formulario estructurado

        if (context === 'viewer') {
            dbSelect = document.getElementById('selectDbViewer');
            viewStoreSelect = document.getElementById('selectStoreViewer');
            storeSelects.push(viewStoreSelect);
        } else if (context === 'admin') {
            dbSelect = document.getElementById('selectDbAdmin');
        } else if (context === 'io') {
            dbSelect = document.getElementById('selectDbImport');
            storeSelects.push(document.getElementById('selectStoreImport'));
        } else if (context === 'export') {
            dbSelect = document.getElementById('selectDbExport');
            storeSelects.push(document.getElementById('selectStoreExport'));
        }

        const dbName = dbSelect ? dbSelect.value : null;

        if (!dbName) {
            storeSelects.forEach(select => {
                select.innerHTML = '<option value="">-- Seleccione Tabla --</option>';
                select.disabled = true;
            });
            return;
        }

        try {
            const db = await openDB(dbName);
            const stores = Array.from(db.objectStoreNames);
            
            storeSelects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- Seleccione Tabla --</option>';
                stores.forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
                select.value = currentVal;
                select.disabled = false;
            });
            log(`Almacenes cargados para DB ${dbName}: ${stores.join(', ')}`, 'info');
            
            // L√≥gica para activar/desactivar el formulario estructurado
            if (context === 'viewer') {
                checkCajaFormActivation(dbName, viewStoreSelect.value);
            }
        } catch (error) {
            log(`Error al cargar almacenes de ${dbName}: ${error.message}`, 'error');
        }
    }

    /** Verifica si se debe mostrar el formulario estructurado */
    function checkCajaFormActivation(dbName, storeName) {
        const isCajaDB = dbName === CAJA_DB_NAME && storeName === CAJA_STORE_NAME;
        const cajaFormTab = document.getElementById('cajaFormTab');
        const btnGeneric = document.getElementById('btnInsertGeneric');

        cajaFormTab.style.display = isCajaDB ? 'block' : 'none';
        btnGeneric.style.display = isCajaDB ? 'none' : 'block';
        
        // Ocultar el formulario JSON gen√©rico si se selecciona la DB de caja
        document.getElementById('crudFormContainer').style.display = 'none';
    }


    async function viewData() {
        const dbName = document.getElementById('selectDbViewer').value;
        const storeName = document.getElementById('selectStoreViewer').value;
        const tableBody = document.querySelector('#dataViewerTable tbody');
        const tableHead = document.querySelector('#dataViewerTable thead');

        // Control de activaci√≥n del formulario estructurado
        checkCajaFormActivation(dbName, storeName);

        tableBody.innerHTML = '<tr><td colspan="3">Cargando datos...</td></tr>';
        tableHead.innerHTML = '';

        if (!dbName || !storeName) {
            tableBody.innerHTML = '<tr><td colspan="3">Seleccione una DB y un Almac√©n.</td></tr>';
            return;
        }

        try {
            const db = await openDB(dbName);
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const keyPath = store.keyPath || 'ID_IndexedDB'; 

            const request = store.openCursor();
            const records = [];

            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    records.push({ key: cursor.key, value: cursor.value });
                    cursor.continue();
                } else {
                    if (records.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3">El almac√©n est√° vac√≠o.</td></tr>';
                        return;
                    }

                    // Determinar las columnas
                    const sample = records[0].value;
                    let headers = [keyPath];
                    if (keyPath === 'ID_IndexedDB') {
                        headers = ['IndexedDB Key', ...Object.keys(sample)];
                    } else {
                        headers = [keyPath, ...Object.keys(sample).filter(k => k !== keyPath)];
                    }
                    headers.push('Acciones');

                    tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

                    tableBody.innerHTML = records.map(record => {
                        let html = `<tr class="data-row">`;
                        
                        const actualKey = store.keyPath ? record.value[store.keyPath] : record.key;
                        html += `<td class="key-column">${actualKey}</td>`;

                        headers.slice(1, -1).forEach(header => {
                            if (header === 'IndexedDB Key') return;
                            const value = record.value[header] !== undefined ? record.value[header] : '';
                            
                            if (typeof value === 'object' && value !== null) {
                                html += `<td class="json-data-cell"><pre>${JSON.stringify(value, null, 2)}</pre></td>`;
                            } else {
                                html += `<td>${value}</td>`;
                            }
                        });
                        
                        // Determinar la acci√≥n de edici√≥n
                        let editAction;
                        if (dbName === CAJA_DB_NAME && storeName === CAJA_STORE_NAME) {
                             // Si es la DB de caja, usar la funci√≥n de edici√≥n estructurada
                            editAction = `editCajaRecord('${record.key.toString()}')`;
                        } else {
                            // Si es gen√©rico, usar la funci√≥n de edici√≥n JSON
                            editAction = `editCrudRecord('${dbName}', '${storeName}', '${record.key.toString()}')`;
                        }

                        html += `<td>
                                <button class="btn-primary" style="margin-right:5px; padding: 5px 8px;" onclick="${editAction}">‚úèÔ∏è</button>
                                <button class="btn-danger" style="padding: 5px 8px;" onclick="deleteRecord('${dbName}', '${storeName}', '${record.key.toString()}')">üóëÔ∏è</button>
                            </td>`;

                        html += `</tr>`;
                        return html;
                    }).join('');

                    log(`Se cargaron ${records.length} registros del almac√©n ${storeName}.`, 'success');
                }
            };
            
            request.onerror = (event) => {
                tableBody.innerHTML = `<tr><td colspan="3" class="message-error">Error al leer datos: ${event.target.error.message}</td></tr>`;
                log(`Error al leer datos: ${event.target.error.message}`, 'error');
            };

        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="3" class="message-error">Error: ${error.message}</td></tr>`;
            log(`Error al ver datos: ${error.message}`, 'error');
        }
    }
    
    // ... (toggleCrudForm, editCrudRecord, saveCrudRecord, deleteRecord - NO CAMBIAN en su l√≥gica gen√©rica) ...

    /** CRUD: Mostrar formulario para insertar o editar (Gen√©rico JSON) */
    async function toggleCrudForm(mode, key = null) {
        const container = document.getElementById('crudFormContainer');
        const title = document.getElementById('crudModeTitle');
        const keyInput = document.getElementById('crudRecordKey');
        const jsonData = document.getElementById('crudJsonData');
        
        container.style.display = 'block';
        keyInput.value = key;

        if (mode === 'insert') {
            title.textContent = 'Insertar';
            jsonData.value = '{\n\t\n}';
        } else if (mode === 'edit' && key) {
            title.textContent = 'Modificar';
            const dbName = document.getElementById('selectDbViewer').value;
            const storeName = document.getElementById('selectStoreViewer').value;
            
            try {
                const db = await openDB(dbName);
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                
                const request = store.get(key);
                request.onsuccess = (event) => {
                    jsonData.value = JSON.stringify(event.target.result, null, 2);
                    keyInput.value = key;
                };
            } catch (error) {
                 log(`Error al cargar registro para edici√≥n: ${error.message}`, 'error');
                 container.style.display = 'none';
            }
        }
    }
    
    /** CRUD: Editar un registro (llama a toggleCrudForm - Gen√©rico JSON) */
    function editCrudRecord(dbName, storeName, key) {
        document.getElementById('selectDbViewer').value = dbName;
        document.getElementById('selectStoreViewer').value = storeName;
        toggleCrudForm('edit', key);
    }

    /** CRUD: Guardar (Insertar o Modificar - Gen√©rico JSON) */
    async function saveCrudRecord() {
        const dbName = document.getElementById('selectDbViewer').value;
        const storeName = document.getElementById('selectStoreViewer').value;
        const key = document.getElementById('crudRecordKey').value;
        const jsonText = document.getElementById('crudJsonData').value;
        
        if (!dbName || !storeName) {
            log('Seleccione Base de Datos y Almac√©n antes de guardar.', 'error');
            return;
        }
        
        try {
            const record = JSON.parse(jsonText);
            const db = await openDB(dbName);
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            
            const mode = key ? 'Modificado' : 'Insertado';
            
            let request;
            if (key) {
                request = store.put(record, key); 
            } else {
                request = store.add(record); 
            }

            request.onsuccess = () => {
                log(`Registro ${mode} con √©xito en ${storeName}. Clave: ${request.result || key}`, 'success');
                document.getElementById('crudFormContainer').style.display = 'none';
                viewData(); 
            };

            request.onerror = (event) => {
                log(`Error al ${mode} registro: ${event.target.error.message}`, 'error');
            };

        } catch (e) {
            log(`Error: El formato JSON es inv√°lido. ${e.message}`, 'error');
        }
    }

    /** CRUD: Eliminar un registro (Gen√©rico) */
    async function deleteRecord(dbName, storeName, key) {
        if (!confirm(`¬øEst√° seguro de eliminar el registro con clave: ${key} de ${dbName}.${storeName}?`)) return;

        try {
            const db = await openDB(dbName);
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            
            const request = store.delete(key);

            request.onsuccess = () => {
                log(`Registro eliminado con √©xito. Clave: ${key}`, 'success');
                viewData(); 
            };

            request.onerror = (event) => {
                log(`Error al eliminar registro: ${event.target.error.message}`, 'error');
            };

        } catch (error) {
            log(`Error al eliminar registro: ${error.message}`, 'error');
        }
    }


    // =======================================================
    // 3. ADMIN DB/TABLAS
    // =======================================================
    // ... (createDatabase, deleteDatabase, createObjectStore, deleteObjectStore - SIN CAMBIOS) ...

    async function createDatabase() {
        const dbName = document.getElementById('dbNameAdmin').value.trim();
        if (!dbName) { log('Especifique el nombre de la DB.', 'error'); return; }

        log(`Intentando crear/abrir DB: ${dbName} (v1)...`, 'info');

        const request = indexedDB.open(dbName, 1);

        request.onerror = (event) => {
            log(`Error al crear DB ${dbName}: ${event.target.error}`, 'error');
        };

        request.onupgradeneeded = (event) => {
            log(`DB ${dbName} creada o actualizada a v1.`, 'success');
        };

        request.onsuccess = (event) => {
            const db = event.target.result;
            db.close(); 
            log(`Conexi√≥n a DB ${dbName} cerrada. Listo para crear almacenes.`, 'success');
            populateDbSelectors(dbName); 
        };
    }

    function deleteDatabase() {
        const dbName = document.getElementById('dbNameAdmin').value.trim();
        if (!dbName) { log('Especifique el nombre de la DB a eliminar.', 'error'); return; }
        if (!confirm(`ADVERTENCIA: ¬øEst√° seguro de eliminar la base de datos completa: ${dbName}? Esto es irreversible.`)) return;

        const deleteRequest = indexedDB.deleteDatabase(dbName);

        deleteRequest.onsuccess = () => {
            log(`Base de datos ${dbName} eliminada con √©xito.`, 'success');
            if (dbRefs[dbName]) delete dbRefs[dbName]; 
            populateDbSelectors();
        };

        deleteRequest.onerror = (event) => {
            log(`Error al eliminar DB ${dbName}: ${event.target.error}`, 'error');
        };
    }
    
    async function createObjectStore() {
        const dbName = document.getElementById('selectDbAdmin').value;
        const storeName = document.getElementById('storeNameAdmin').value.trim();
        const keyPath = document.getElementById('keyPathAdmin').value.trim() || undefined;

        if (!dbName || !storeName) {
            log('Seleccione DB y nombre de Almac√©n.', 'error');
            return;
        }

        try {
            const db = await openDB(dbName);
            const currentVersion = db.version;
            db.close(); 

            const newVersion = currentVersion + 1;
            log(`Preparando actualizaci√≥n de ${dbName} a v${newVersion} para crear almac√©n...`, 'info');

            const request = indexedDB.open(dbName, newVersion);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(storeName)) {
                    db.createObjectStore(storeName, { keyPath: keyPath || undefined, autoIncrement: !keyPath });
                    log(`Almac√©n ${storeName} creado con √©xito.`, 'success');
                } else {
                    log(`El almac√©n ${storeName} ya existe.`, 'error');
                }
            };

            request.onsuccess = (event) => {
                event.target.result.close();
                log(`DB ${dbName} actualizada y Almac√©n ${storeName} listo.`, 'success');
                loadObjectStores('admin');
            };

            request.onerror = (event) => {
                log(`Error en la creaci√≥n del almac√©n: ${event.target.error.message}`, 'error');
            };

        } catch (e) {
            log(`Error general al intentar crear almac√©n: ${e.message}`, 'error');
        }
    }

    async function deleteObjectStore() {
        const dbName = document.getElementById('selectDbAdmin').value;
        const storeName = document.getElementById('storeNameAdmin').value.trim(); 

        if (!dbName || !storeName) {
            log('Seleccione DB y especifique el nombre del Almac√©n a eliminar.', 'error');
            return;
        }
        if (!confirm(`¬øEst√° seguro de eliminar el Almac√©n/Tabla: ${storeName} de la DB ${dbName}?`)) return;

        try {
            const db = await openDB(dbName);
            const currentVersion = db.version;
            db.close(); 

            const newVersion = currentVersion + 1;
            log(`Preparando actualizaci√≥n de ${dbName} a v${newVersion} para eliminar almac√©n...`, 'info');

            const request = indexedDB.open(dbName, newVersion);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (db.objectStoreNames.contains(storeName)) {
                    db.deleteObjectStore(storeName);
                    log(`Almac√©n ${storeName} eliminado con √©xito.`, 'success');
                } else {
                    log(`El almac√©n ${storeName} no existe.`, 'error');
                }
            };

            request.onsuccess = (event) => {
                event.target.result.close();
                log(`DB ${dbName} actualizada.`, 'success');
                loadObjectStores('admin');
            };

            request.onerror = (event) => {
                log(`Error en la eliminaci√≥n del almac√©n: ${event.target.error.message}`, 'error');
            };
        } catch (e) {
            log(`Error general al intentar eliminar almac√©n: ${e.message}`, 'error');
        }
    }

    // =======================================================
    // 4. IMPORTAR / EXPORTAR
    // =======================================================
    // ... (exportData, exportDatabase, importData, downloadFile - SIN CAMBIOS) ...

    async function exportData() {
        const dbName = document.getElementById('selectDbExport').value;
        const storeName = document.getElementById('selectStoreExport').value;

        if (!dbName || !storeName) {
            log('Seleccione Base de Datos y Almac√©n para exportar.', 'error');
            return;
        }

        try {
            const db = await openDB(dbName);
            const tx = db.transaction(storeName, 'readonly');
            const store = tx.objectStore(storeName);
            const request = store.getAll();

            request.onsuccess = () => {
                const data = request.result;
                const json = JSON.stringify(data, null, 2);
                
                downloadFile(json, `${dbName}_${storeName}_export.json`, 'application/json');
                log(`Datos de ${storeName} exportados con √©xito.`, 'success');
            };

            request.onerror = (event) => {
                log(`Error al exportar datos: ${event.target.error.message}`, 'error');
            };

        } catch (error) {
            log(`Error al exportar: ${error.message}`, 'error');
        }
    }

    async function exportDatabase() {
        const dbName = document.getElementById('selectDbExport').value;
        if (!dbName) { log('Seleccione Base de Datos para exportar.', 'error'); return; }

        try {
            const db = await openDB(dbName);
            const exportData = {};
            const stores = Array.from(db.objectStoreNames);
            let storesProcessed = 0;

            if (stores.length === 0) {
                log(`La DB ${dbName} no contiene almacenes (tablas).`, 'warning');
                return;
            }

            stores.forEach(storeName => {
                const tx = db.transaction(storeName, 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();

                request.onsuccess = () => {
                    exportData[storeName] = request.result;
                    storesProcessed++;
                    
                    if (storesProcessed === stores.length) {
                        const json = JSON.stringify(exportData, null, 2);
                        downloadFile(json, `${dbName}_FULL_EXPORT.json`, 'application/json');
                        log(`DB completa ${dbName} exportada con √©xito (tablas: ${stores.join(', ')}).`, 'success');
                    }
                };

                request.onerror = (event) => {
                    log(`Error al exportar almac√©n ${storeName}: ${event.target.error.message}`, 'error');
                    storesProcessed++; 
                };
            });
        } catch (error) {
            log(`Error al exportar DB completa: ${error.message}`, 'error');
        }
    }

    async function importData() {
        const dbName = document.getElementById('selectDbImport').value;
        const storeName = document.getElementById('selectStoreImport').value;
        const jsonText = document.getElementById('importJsonData').value.trim();

        if (!dbName || !storeName || !jsonText) {
            log('Seleccione DB, Almac√©n y pegue los datos JSON.', 'error');
            return;
        }

        try {
            const dataArray = JSON.parse(jsonText);
            if (!Array.isArray(dataArray)) {
                throw new Error('El JSON debe ser un array de objetos ([{...}, {...}])');
            }

            const db = await openDB(dbName);
            const tx = db.transaction(storeName, 'readwrite');
            const store = tx.objectStore(storeName);
            let successCount = 0;

            dataArray.forEach(record => {
                const request = store.add(record); 

                request.onsuccess = () => {
                    successCount++;
                };

                request.onerror = (event) => {
                    log(`Error al importar un registro: ${event.target.error.message}. Puede que la clave ya exista.`, 'error');
                };
            });

            tx.oncomplete = () => {
                log(`Importaci√≥n finalizada. ${successCount} de ${dataArray.length} registros a√±adidos a ${storeName}.`, 'success');
                if (document.getElementById('selectDbViewer').value === dbName && document.getElementById('selectStoreViewer').value === storeName) {
                    viewData();
                }
            };
            tx.onerror = (event) => {
                log(`Transacci√≥n de importaci√≥n fallida: ${event.target.error.message}`, 'error');
            };

        } catch (e) {
            log(`Error de formato al importar: ${e.message}`, 'error');
        }
    }

    function downloadFile(content, fileName, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // =======================================================
    // 5. FORMULARIO ESTRUCTURADO (CAJA DIARIA)
    // =======================================================

    /** Convierte el registro de la DB al formato del formulario */
    function recordToForm(record) {
        document.getElementById('cajaDate').value = record.date || '';
        document.getElementById('cajaTpv').value = parseFloat(record.tpv || 0).toFixed(2);
        document.getElementById('cajaFondoAnterior').value = parseFloat(record.fondoAnterior || 0).toFixed(2);
        document.getElementById('cajaContenidoTotal').value = parseFloat(record.contenidoTotal || 0).toFixed(2);
        document.getElementById('cajaManEfec').value = parseFloat(record.manEfec || 0).toFixed(2);
        document.getElementById('cajaManTarj').value = parseFloat(record.manTarj || 0).toFixed(2);
        document.getElementById('cajaOrdEfec').value = parseFloat(record.ordEfec || 0).toFixed(2);
        document.getElementById('cajaOrdTarj').value = parseFloat(record.ordTarj || 0).toFixed(2);
        document.getElementById('cajaRegEfecGral').value = parseFloat(record.regEfecGral || 0).toFixed(2); // Calculado
        document.getElementById('cajaObservaciones').value = record.observaciones || '';
        
        // Asumiendo que los detalles manualDetails, ordenadorDetails y cashDetails no se editar√°n aqu√≠,
        // ya que el formulario original solo permit√≠a editar los totales, no el desglose interno.
        // Si necesita el desglose, podr√≠amos a√±adir campos de texto JSON para esos arrays.
    }

    /** Convierte el formulario al formato del registro de la DB */
    function formToRecord(key, mode, oldRecord = {}) {
        const manEfec = parseFloat(document.getElementById('cajaManEfec').value) || 0;
        const manTarj = parseFloat(document.getElementById('cajaManTarj').value) || 0;
        const ordEfec = parseFloat(document.getElementById('cajaOrdEfec').value) || 0;
        const ordTarj = parseFloat(document.getElementById('cajaOrdTarj').value) || 0;
        const fondoAnterior = parseFloat(document.getElementById('cajaFondoAnterior').value) || 0;
        const contenidoTotal = parseFloat(document.getElementById('cajaContenidoTotal').value) || 0;
        const regEfecGral = contenidoTotal - fondoAnterior;
        
        const newRecord = {
            id: key ? parseInt(key) : undefined,
            date: document.getElementById('cajaDate').value || new Date().toLocaleDateString('es-ES'),
            tpv: parseFloat(document.getElementById('cajaTpv').value) || 0,
            manGral: manEfec + manTarj,
            manEfec: manEfec,
            manTarj: manTarj,
            ordGral: ordEfec + ordTarj,
            ordEfec: ordEfec,
            ordTarj: ordTarj,
            fondoAnterior: fondoAnterior,
            contenidoTotal: contenidoTotal,
            regEfecGral: regEfecGral,
            desc: regEfecGral - ordEfec, // Descuadre
            observaciones: document.getElementById('cajaObservaciones').value.trim(),
            
            // Conservar detalles complejos si existen en el registro antiguo
            manualDetails: oldRecord.manualDetails || [],
            ordenadorDetails: oldRecord.ordenadorDetails || [],
            cashDetails: oldRecord.cashDetails || [],
        };
        
        return newRecord;
    }

    /** Inicia el formulario para un nuevo registro */
    function startNewCajaRecord() {
        showTab('cajaForm');
        document.getElementById('cajaFormTitle').textContent = 'Insertar Nuevo Cierre';
        document.getElementById('cajaRecordKey').value = '';
        document.getElementById('cajaMode').value = 'insert';
        recordToForm({ 
            date: new Date().toLocaleDateString('es-ES'), 
            fondoAnterior: 100.00 // Valor por defecto
        }); 
    }

    /** Inicia el formulario para editar un registro existente */
    async function editCajaRecord(key) {
        if (!key) return;
        
        try {
            const db = await openDB(CAJA_DB_NAME);
            const tx = db.transaction(CAJA_STORE_NAME, 'readonly');
            const store = tx.objectStore(CAJA_STORE_NAME);
            
            const request = store.get(parseInt(key));

            request.onsuccess = (event) => {
                const record = event.target.result;
                if (record) {
                    showTab('cajaForm');
                    document.getElementById('cajaFormTitle').textContent = `Modificar Cierre ID: ${key}`;
                    document.getElementById('cajaRecordKey').value = key;
                    document.getElementById('cajaMode').value = 'edit';
                    recordToForm(record);
                    log(`Registro ID ${key} cargado para edici√≥n estructurada.`, 'success');
                } else {
                    log(`Registro ID ${key} no encontrado.`, 'error');
                }
            };
            request.onerror = (event) => {
                log(`Error al buscar registro ID ${key}: ${event.target.error.message}`, 'error');
            };
            
        } catch (error) {
            log(`Error de conexi√≥n al cargar el registro: ${error.message}`, 'error');
        }
    }

    /** Guarda el registro del formulario estructurado */
    async function saveCajaRecord() {
        const key = document.getElementById('cajaRecordKey').value;
        const mode = key ? 'edit' : 'insert';
        let oldRecord = {};
        
        try {
            const db = await openDB(CAJA_DB_NAME);
            
            if (mode === 'edit') {
                const txRead = db.transaction(CAJA_STORE_NAME, 'readonly');
                oldRecord = await new Promise((resolve, reject) => {
                    const req = txRead.objectStore(CAJA_STORE_NAME).get(parseInt(key));
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = (e) => reject(e.target.error);
                });
            }
            
            const recordToSave = formToRecord(key, mode, oldRecord);
            
            const txWrite = db.transaction(CAJA_STORE_NAME, 'readwrite');
            const store = txWrite.objectStore(CAJA_STORE_NAME);
            
            let request;
            if (mode === 'edit') {
                request = store.put(recordToSave);
            } else {
                request = store.add(recordToSave);
            }

            request.onsuccess = () => {
                log(`Cierre ${mode === 'edit' ? 'modificado' : 'insertado'} con √©xito. ID: ${request.result || key}`, 'success');
                viewData(); // Recargar la tabla en la vista
                showTab('viewer'); // Volver a la pesta√±a de visualizaci√≥n
            };

            request.onerror = (event) => {
                log(`Error al guardar cierre: ${event.target.error.message}`, 'error');
            };

        } catch (e) {
            log(`Error en la transacci√≥n de guardado: ${e.message}`, 'error');
        }
    }

    // =======================================================
    // INICIALIZACI√ìN
    // =======================================================
    document.addEventListener('DOMContentLoaded', () => {
        showTab('dashboard');
        
        // A√±adir el bot√≥n de inserci√≥n de Caja Diaria al visualizador
        const btnInsertGeneric = document.getElementById('btnInsertGeneric');
        const btnInsertCaja = document.createElement('button');
        btnInsertCaja.className = 'btn-success';
        btnInsertCaja.textContent = '‚ûï Insertar Nuevo Cierre (Estructurado)';
        btnInsertCaja.onclick = startNewCajaRecord;
        btnInsertCaja.id = 'btnInsertCaja';
        btnInsertCaja.style.marginLeft = '10px';
        btnInsertCaja.style.display = 'none'; // Oculto por defecto
        btnInsertGeneric.parentNode.insertBefore(btnInsertCaja, btnInsertGeneric.nextSibling);

        // Modificar el listener del select de Almac√©n para mostrar/ocultar el bot√≥n
        const selectStoreViewer = document.getElementById('selectStoreViewer');
        selectStoreViewer.onchange = () => {
            viewData();
            const dbName = document.getElementById('selectDbViewer').value;
            const storeName = selectStoreViewer.value;
            const isCajaDB = dbName === CAJA_DB_NAME && storeName === CAJA_STORE_NAME;
            
            document.getElementById('cajaFormTab').style.display = isCajaDB ? 'block' : 'none';
            document.getElementById('btnInsertCaja').style.display = isCajaDB ? 'block' : 'none';
            document.getElementById('btnInsertGeneric').style.display = isCajaDB ? 'none' : 'block';
        };
    });

</script>

</body>
</html>