<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Lletres M√†giques PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="manifest" href='data:application/manifest+json,{"short_name":"Lletres","name":"Lletres M√†giques","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/588/588395.png","sizes":"512x512","type":"image/png"}],"start_url":"index.html","display":"standalone","background_color":"#F8F9FA","theme_color":"#A2D2FF"}'>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root { 
            --fons: #F8F9FA; 
            --text: #495057;
            --primari: #A2D2FF; /* Blau past√≠s */
            --accent: #FFAFCC;  /* Rosa past√≠s */
            --exit: #B9FBC0;    /* Verd menta */
            --error: #FFCFD2;   /* Vermell suau */
            --blanc: #ffffff;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            background-color: var(--fons); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            color: var(--text);
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* Pantalla d'Inici */
        #pantalla-usuari { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 40px 20px; background: var(--primari);
            min-height: 100vh; text-align: center; color: white;
        }

        .llista-perfils { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; }
        
        .perfil-card { 
            background: var(--blanc); color: var(--text); padding: 15px; 
            border-radius: 20px; width: 110px; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .perfil-card:active { transform: scale(0.95); }

        /* Contenidor de Joc */
        #joc-contenedor { display: none; flex-direction: column; min-height: 100vh; }

        #barra-superior { 
            background: var(--blanc); padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; position: sticky; top: 0; z-index: 10;
        }

        #zona-principal { 
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; padding: 20px; gap: 20px;
        }

        /* Targeta de Paraula */
        #targeta { 
            background: var(--blanc); padding: 20px; border-radius: 30px; 
            text-align: center; width: 250px; box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            border: 4px solid var(--accent);
        }

        /* Canvas */
        #canvas-wrap { position: relative; width: 100%; max-width: 600px; display: flex; justify-content: center; }
        canvas { 
            background: var(--blanc); border-radius: 25px; 
            border: 5px solid var(--primari); width: 100%; height: auto;
            touch-action: none; cursor: crosshair;
        }

        /* Missatges de Feedback (Substitueixen l'alert) */
        #feedback-msg { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; border-radius: 20px; font-weight: bold; font-size: 1.2rem;
            display: none; z-index: 1000; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Botons */
        .controls { display: flex; gap: 15px; }
        button { 
            border: none; border-radius: 50px; font-weight: bold; 
            padding: 15px 30px; font-size: 1rem; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-exit { background-color: var(--exit); color: #2d5a27; }
        .btn-error { background-color: var(--error); color: #8b3a3a; }
        .btn-neutre { background-color: #eee; color: #666; }

        input { padding: 12px; border-radius: 15px; border: none; margin-bottom: 10px; width: 200px; }
    </style>
</head>
<body>

<div id="feedback-msg"></div>

<div id="pantalla-usuari">
    <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Lletres M√†giques ‚úèÔ∏è</h1>
    <p>Escriu en min√∫scules per guanyar estrelles!</p>
    
    <div style="margin: 20px 0;">
        <input type="text" id="nou-nom" placeholder="Com et dius?">
        <button onclick="crearUsuari()" style="background: var(--accent); color: white;">Comen√ßar</button>
    </div>

    <div class="llista-perfils" id="llista-perfils"></div>
    
    <div id="ranking-container" style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 25px; width: 100%; max-width: 400px;">
        <h3>üèÜ Millors R√®cords</h3>
        <div id="llista-ranking"></div>
    </div>
</div>

<div id="joc-contenedor">
    <div id="barra-superior">
        <div id="usuari-info" style="font-weight: bold;"></div>
        <div style="font-size: 1.2rem;">‚≠ê <span id="estrelles-comptador">0</span></div>
        <button onclick="tornarAInici()" class="btn-neutre" style="padding: 8px 15px; font-size: 0.8rem;">Sortir</button>
    </div>

    <div id="zona-principal">
        <div id="vides-display" style="font-size: 1.8rem; letter-spacing: 5px;"></div>
        
        <div id="targeta">
            <div id="paraula-imatge" style="font-size: 80px; margin-bottom: 10px;"></div>
            <div id="paraula-text" style="font-size: 35px; font-weight: bold; color: var(--text); letter-spacing: 2px;"></div>
        </div>

        <div id="canvas-wrap">
            <canvas id="pissarra"></canvas>
        </div>

        <div class="controls">
            <button onclick="netejar()" class="btn-error">Esborrar</button>
            <button id="btn-revisar" onclick="comprovar()" class="btn-exit">Revisar üëç</button>
        </div>
    </div>
</div>

<script>
    const baseDades = [
        {p: "poma", i: "üçé"}, {p: "gat", i: "üê±"}, {p: "casa", i: "üè†"}, {p: "gos", i: "üê∂"},
        {p: "sol", i: "‚òÄÔ∏è"}, {p: "mar", i: "üåä"}, {p: "lluna", i: "üåô"}, {p: "arbre", i: "üå≥"},
        {p: "peix", i: "üêü"}, {p: "flor", i: "üå∏"}, {p: "peu", i: "ü¶∂"}, {p: "ma", i: "‚úã"}
    ];

    let usuarios = JSON.parse(localStorage.getItem('lletres_magic_v7')) || {};
    let usuariActiu = null, nivelActual = 1, estrelles = 0, paraulaActual = null;
    let tra√ßos = [], tra√ßActual = [], dibuixant = false, errors = 0;
    let audioCtx = null;

    const canvas = document.getElementById('pissarra');
    const ctx = canvas.getContext('2d');

    function ajustarMida() {
        const wrap = document.getElementById('canvas-wrap');
        canvas.width = wrap.clientWidth;
        canvas.height = 300;
        netejar();
    }

    window.addEventListener('resize', ajustarMida);

    function mostrarFeedback(text, color) {
        const el = document.getElementById('feedback-msg');
        el.innerText = text;
        el.style.backgroundColor = color;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
    }

    function iniciarAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function sonar(f, dur = 0.2) {
        if(!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + dur);
    }

    function seleccionarUsuari(nom) {
        iniciarAudio();
        usuariActiu = nom; 
        estrelles = usuarios[nom].estrelles || 0;
        document.getElementById('pantalla-usuari').style.display = 'none';
        document.getElementById('joc-contenedor').style.display = 'flex';
        document.getElementById('usuari-info').innerText = "üë§ " + nom;
        ajustarMida();
        novaParaula();
    }

    function novaParaula() {
        paraulaActual = baseDades[Math.floor(Math.random()*baseDades.length)];
        errors = 0;
        dibuixarVides();
        document.getElementById('paraula-imatge').innerText = paraulaActual.i;
        document.getElementById('paraula-text').innerText = paraulaActual.p;
        document.getElementById('estrelles-comptador').innerText = estrelles;
        netejar();
    }

    async function comprovar() {
        if(tra√ßos.length === 0) return;
        const btn = document.getElementById('btn-revisar');
        btn.innerText = "...";
        
        const dades = { "options": "enable_pre_space", "requests": [{ "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height }, "ink": tra√ßos.map(t => [t.map(p => p[0]), t.map(p => p[1])]), "language": "ca" }] };
        
        try {
            const r = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=autotext&cs=1&oe=UTF-8', {
                method: 'POST', body: JSON.stringify(dades)
            });
            const res = await r.json();
            if(res[0] === "SUCCESS") validar(res[1][0][1][0]);
        } catch (e) { mostrarFeedback("Sense connexi√≥", "white"); }
        btn.innerText = "Revisar üëç";
    }

    function validar(llegit) {
        if(llegit === paraulaActual.p) {
            estrelles++;
            sonar(523, 0.4);
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#A2D2FF', '#FFAFCC', '#B9FBC0'] });
            mostrarFeedback("Molt b√©! ‚ú®", "#B9FBC0");
            guardarDades();
            setTimeout(novaParaula, 2000);
        } else {
            errors++;
            sonar(150, 0.3);
            if(llegit.toLowerCase() === paraulaActual.p) {
                mostrarFeedback("Usa min√∫scules! ‚ö†Ô∏è", "#FFCFD2");
            } else {
                mostrarFeedback("Torna-ho a provar! ‚úèÔ∏è", "#FFCFD2");
            }
            netejar();
            dibuixarVides();
            if(errors >= 3) { setTimeout(novaParaula, 1500); }
        }
    }

    function netejar() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        tra√ßos = [];
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 2;
        [75, 150, 225].forEach(y => { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); });
        ctx.strokeStyle = '#495057';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
    }

    function obtenirPos(e) {
        const r = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    canvas.addEventListener('touchstart', (e) => { 
        e.preventDefault(); dibuixant = true; tra√ßActual = []; 
        const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); 
    });
    canvas.addEventListener('touchmove', (e) => { 
        if(!dibuixant) return; const p = obtenirPos(e); 
        ctx.lineTo(p.x, p.y); ctx.stroke(); 
        tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); 
    });
    window.addEventListener('touchend', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });
    // Ratol√≠ per proves en PC
    canvas.addEventListener('mousedown', (e) => { dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(dibuixant) { const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); } });
    window.addEventListener('mouseup', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });

    function crearUsuari() {
        const nom = document.getElementById('nou-nom').value.trim();
        if(nom && !usuarios[nom]) {
            usuarios[nom] = { estrelles: 0 };
            guardarDades();
            renderPerfils();
            document.getElementById('nou-nom').value = '';
        }
    }

    function renderPerfils() {
        const c = document.getElementById('llista-perfils'); c.innerHTML = '';
        for (let n in usuarios) {
            c.innerHTML += `<div class="perfil-card" onclick="seleccionarUsuari('${n}')">üë§<br><b>${n}</b></div>`;
        }
        renderRanking();
    }

    function renderRanking() {
        const r = document.getElementById('llista-ranking'); r.innerHTML = '';
        Object.keys(usuarios).sort((a,b) => usuarios[b].estrelles - usuarios[a].estrelles).slice(0,5).forEach((n,i) => {
            r.innerHTML += `<div style="display:flex; justify-content:space-between; margin:5px 0"><span>${i+1}. ${n}</span><span>${usuarios[n].estrelles} ‚≠ê</span></div>`;
        });
    }

    function dibuixarVides() { document.getElementById('vides-display').innerHTML = "‚ù§Ô∏è".repeat(3-errors) + "üñ§".repeat(errors); }
    function guardarDades() { 
        if(usuariActiu) usuarios[usuariActiu].estrelles = estrelles;
        localStorage.setItem('lletres_magic_v7', JSON.stringify(usuarios)); 
    }
    function tornarAInici() { location.reload(); }
    window.onload = renderPerfils;
</script>
</body>
</html>