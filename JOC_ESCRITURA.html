<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Lletres MÃ giques PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#a2d2ff">

    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">

    <style>
        :root { 
            --fons: #fefaf0; 
            --primari: #ffb07c; 
            --exit: #b9fbc0; 
            --error: #ffcfd2; 
            --cel: #a2d2ff; 
            --text: #555;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body { 
            margin: 0; padding: 0;
            background-color: var(--fons); 
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            min-height: 100%;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        #pantalla-usuari { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 30px 20px; color: white; background: var(--cel);
            min-height: 100vh; text-align: center;
        }

        #joc-contenedor { display: none; flex-direction: row; min-height: 100vh; }

        #panell-lateral { 
            width: 180px; background: white; border-right: 4px solid #f0f0f0; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px 10px; flex-shrink: 0;
        }

        #zona-principal { 
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; padding: 10px; gap: 8px; width: 100%;
        }

        @media (max-width: 850px) {
            #joc-contenedor { flex-direction: column; }
            #panell-lateral { 
                width: 100%; flex-direction: row; justify-content: space-around; 
                border-right: none; border-bottom: 4px solid #f0f0f0;
                padding: 10px; position: sticky; top: 0; z-index: 10;
            }
            #llista-nivells { display: none; }
        }

        canvas { 
            background: white; border-radius: 20px; border: 4px solid var(--cel); 
            max-width: 95vw; height: auto;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05); 
            touch-action: none; 
        }

        #capa-premi {
            position: fixed; inset: 0; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; font-size: 6rem;
        }
        .animar-premi { animation: popEstrella 1.2s ease-out forwards; }
        @keyframes popEstrella {
            0% { transform: scale(0.2); opacity: 0; }
            20% { opacity: 1; transform: scale(1.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: translateY(-200px); }
        }

        #cartell-nivell {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: var(--primari); color: white; padding: 20px 40px;
            border-radius: 30px; font-size: 2rem; z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); pointer-events: none;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center; border: 5px solid white;
        }
        #cartell-nivell.show { transform: translate(-50%, -50%) scale(1); }

        .perfil-card { 
            background: white; color: var(--text); padding: 15px; border-radius: 15px; 
            width: 110px; cursor: pointer; margin: 10px; text-align: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative;
        }
        
        .btn-eliminar {
            position: absolute; top: -5px; right: -5px;
            background: var(--error); color: #8b3a3a; border-radius: 50%;
            width: 25px; height: 25px; display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nivell-item { padding: 8px; margin: 4px; border-radius: 10px; font-size: 0.8rem; width: 90%; text-align: center; background: #f9f9f9; color: #888; }
        .nivell-item.actiu { background: var(--primari); color: white; }
        .nivell-item.completat { background: var(--exit); color: #2d5a27; }

        button { cursor: pointer; border: none; border-radius: 50px; font-weight: bold; font-family: inherit; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-accio { padding: 12px 25px; color: var(--text); font-size: 1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.05); }
        
        input { padding: 12px; border-radius: 12px; border: none; width: 150px; outline: none; font-family: inherit; }

        .credits { font-size: 10px; opacity: 0.7; margin-top: 30px; color: #fff; }

        .grup-botons { display: flex; gap: 15px; margin: 5px 0; }
    </style>
</head>
<body>

<div id="capa-premi">ğŸŒŸ</div>
<div id="cartell-nivell">ğŸ‰ NIVELL SUPERAT! ğŸ‰</div>

<div id="pantalla-usuari">
    <h1>Lletres MÃ giques âœï¸</h1>
    <div style="margin-bottom: 25px;">
        <input type="text" id="nou-nom" placeholder="El teu nom...">
        <button onclick="crearUsuari()" style="background: var(--primari); padding:12px 20px; color:white;">Afegir</button>
    </div>
    <div class="llista-perfils" id="llista-perfils" style="display:flex; flex-wrap:wrap; justify-content:center; width: 100%;"></div>
    
    <div id="ranking-container" style="width: 100%; max-width: 400px; margin-top: 20px; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 20px; color: #555;">
        <h3 style="margin:0">ğŸ† Millors RÃ¨cords</h3>
        <div id="llista-ranking"></div>
    </div>

    <div class="credits">Ha estat ideat per Juanjo</div>
</div>

<div id="joc-contenedor">
    <div id="panell-lateral">
        <div id="info-usuari" style="color: var(--text);"></div>
        <div style="font-size: 1.5rem; margin: 10px 0;">â­ <span id="num-totals">0</span></div>
        <div id="llista-nivells" style="width: 100%;"></div>
        <button onclick="tornarAInici()" style="background:#f0f0f0; color:#888; padding:8px; margin-top:auto; width:100%; border-radius: 10px;">Sortir</button>
    </div>

    <div id="zona-principal">
        <div id="contenidor-vides" style="font-size: 1.5rem;">â¤ï¸â¤ï¸â¤ï¸</div>
        
        <div id="targeta" style="background:white; padding:10px; border-radius:20px; text-align:center; min-width: 180px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 3px solid #fff;">
            <div id="imatge-paraula" style="font-size:40px;"></div>
            <div id="nom-paraula" style="font-size:25px; font-weight:bold; border-top:2px dashed #f0f0f0; color: #444;"></div>
        </div>

        <div class="grup-botons">
            <button onclick="netejar()" class="btn-accio" style="background:var(--error); color: #8b3a3a;">Esborrar</button>
            <button class="btn-revisar btn-accio" onclick="comprovar()" style="background:var(--exit); color: #2d5a27;">Revisar ğŸ‘</button>
        </div>
        
        <canvas id="pissarra"></canvas>
        
        <div class="grup-botons">
            <button onclick="netejar()" class="btn-accio" style="background:var(--error); color: #8b3a3a;">Esborrar</button>
            <button class="btn-revisar btn-accio" onclick="comprovar()" style="background:var(--exit); color: #2d5a27;">Revisar ğŸ‘</button>
        </div>
    </div>
</div>

<script>
    const baseDeDades = [
        {p: "gat", i: "ğŸ±"}, {p: "gos", i: "ğŸ¶"}, {p: "porc", i: "ğŸ·"}, {p: "ruc", i: "ğŸ«"},
        {p: "vaca", i: "ğŸ®"}, {p: "lleÃ³", i: "ğŸ¦"}, {p: "mico", i: "ğŸ’"}, {p: "peix", i: "ğŸŸ"},
        {p: "ocell", i: "ğŸ¦"}, {p: "cavall", i: "ğŸ´"}, {p: "ratolÃ­", i: "ğŸ­"}, {p: "serp", i: "ğŸ"},
        {p: "balena", i: "ğŸ³"}, {p: "taurÃ³", i: "ğŸ¦ˆ"}, {p: "pop", i: "ğŸ™"}, {p: "cranc", i: "ğŸ¦€"},
        {p: "abella", i: "ğŸ"}, {p: "cuc", i: "ğŸ›"}, {p: "granota", i: "ğŸ¸"}, {p: "tortuga", i: "ğŸ¢"},
        {p: "elefant", i: "ğŸ˜"}, {p: "tigre", i: "ğŸ¯"}, {p: "gallina", i: "ğŸ”"}, {p: "pollet", i: "ğŸ¥"},
        {p: "poma", i: "ğŸ"}, {p: "pa", i: "ğŸ¥–"}, {p: "llet", i: "ğŸ¥›"}, {p: "ou", i: "ğŸ¥š"},
        {p: "formatge", i: "ğŸ§€"}, {p: "carn", i: "ğŸ¥©"}, {p: "arrÃ²s", i: "ğŸš"}, {p: "sopa", i: "ğŸ¥£"},
        {p: "gelat", i: "ğŸ¦"}, {p: "pizza", i: "ğŸ•"}, {p: "mel", i: "ğŸ¯"}, {p: "suc", i: "ğŸ¹"},
        {p: "raÃ¯m", i: "ğŸ‡"}, {p: "pera", i: "ğŸ"}, {p: "plÃ tan", i: "ğŸŒ"}, {p: "cirera", i: "ğŸ’"},
        {p: "llimona", i: "ğŸ‹"}, {p: "taronja", i: "ğŸŠ"}, {p: "kiwi", i: "ğŸ¥"}, {p: "maduixa", i: "ğŸ“"},
        {p: "casa", i: "ğŸ "}, {p: "taula", i: "ğŸª‘"}, {p: "llit", i: "ğŸ›ï¸"}, {p: "cadira", i: "ğŸª‘"},
        {p: "llapis", i: "âœï¸"}, {p: "goma", i: "ğŸ§¼"}, {p: "llibre", i: "ğŸ“–"}, {p: "clau", i: "ğŸ”‘"},
        {p: "got", i: "ğŸ¥›"}, {p: "pala", i: "ğŸ§¹"}, {p: "raspall", i: "ğŸª¥"}, {p: "mirall", i: "ğŸª"},
        {p: "rellotge", i: "âŒš"}, {p: "telÃ¨fon", i: "ğŸ“±"}, {p: "motxilla", i: "ğŸ’"}, {p: "tisores", i: "âœ‚ï¸"},
        {p: "martell", i: "ğŸ”¨"}, {p: "galleda", i: "ğŸª£"}, {p: "pilota", i: "âš½"}, {p: "nina", i: "ğŸª†"},
        {p: "sol", i: "â˜€ï¸"}, {p: "lluna", i: "ğŸŒ™"}, {p: "estel", i: "â­"}, {p: "arbre", i: "ğŸŒ³"},
        {p: "flor", i: "ğŸŒ»"}, {p: "cel", i: "â˜ï¸"}, {p: "mar", i: "ğŸŒŠ"}, {p: "riu", i: "ğŸï¸"},
        {p: "muntanya", i: "â›°ï¸"}, {p: "bosc", i: "ğŸŒ²"}, {p: "platja", i: "ğŸ–ï¸"}, {p: "pedra", i: "ğŸª¨"},
        {p: "foc", i: "ğŸ”¥"}, {p: "pluja", i: "ğŸŒ§ï¸"}, {p: "neu", i: "â„ï¸"}, {p: "vent", i: "ğŸŒ¬ï¸"},
        {p: "mÃ ", i: "âœ‹"}, {p: "peu", i: "ğŸ¦¶"}, {p: "nas", i: "ğŸ‘ƒ"}, {p: "ull", i: "ğŸ‘ï¸"},
        {p: "boca", i: "ğŸ‘„"}, {p: "orella", i: "ğŸ‘‚"}, {p: "cap", i: "ğŸ™†"}, {p: "dit", i: "â˜ï¸"},
        {p: "panxa", i: "ğŸ¤°"}, {p: "dent", i: "ğŸ¦·"}, {p: "coll", i: "ğŸ§£"}, {p: "braÃ§", i: "ğŸ’ª"},
        {p: "cotxe", i: "ğŸš—"}, {p: "tren", i: "ğŸš‚"}, {p: "aviÃ³", i: "âœˆï¸"}, {p: "nau", i: "ğŸš€"},
        {p: "vaixell", i: "ğŸš¢"}, {p: "moto", i: "ğŸï¸"}, {p: "bici", i: "ğŸš²"}, {p: "bus", i: "ğŸšŒ"},
        {p: "blau", i: "ğŸŸ¦"}, {p: "groc", i: "ğŸŸ¨"}, {p: "verd", i: "ğŸŸ©"}, {p: "rosa", i: "ğŸŒ¸"},
        {p: "roig", i: "ğŸŸ¥"}, {p: "lila", i: "ğŸ’œ"}, {p: "blanc", i: "â¬œ"}, {p: "negre", i: "â¬›"}
    ];

    let paraulesPendents = []; 
    let usuarios = JSON.parse(localStorage.getItem('joc_v6_final')) || {};
    let usuariActiu = null, nivelActual = 1, estrellesTotals = 0, paraulaActual = null;
    let traÃ§os = [], traÃ§Actual = [], dibuixant = false, intentsFallits = 0;
    let audioCtx = null;

    const canvas = document.getElementById('pissarra');
    const ctx = canvas.getContext('2d');

    function ajustarCanvas() {
        const ampleMax = Math.min(window.innerWidth - 40, 600);
        const alturaDisponible = window.innerHeight - (window.innerWidth < 850 ? 300 : 400);
        // Canvas mÃ©s petit per adaptar millor
        canvas.width = ampleMax;
        canvas.height = Math.max(180, Math.min(260, alturaDisponible)); 
        netejar();
    }

    window.addEventListener('resize', ajustarCanvas);
    window.addEventListener('orientationchange', () => setTimeout(ajustarCanvas, 300));

    function iniciarAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    function sonar(f, durada = 0.2) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + durada);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + durada);
    }

    function sonarNivell() {
        const notes = [261.63, 329.63, 392.00, 523.25];
        notes.forEach((f, i) => setTimeout(() => sonar(f, 0.4), i * 150));
    }

    function seleccionarUsuari(nom) {
        iniciarAudio();
        usuariActiu = nom; nivelActual = usuarios[nom].nivel || 1; estrellesTotals = usuarios[nom].estrelles || 0;
        document.getElementById('pantalla-usuari').style.display = 'none';
        document.getElementById('joc-contenedor').style.display = 'flex';
        document.getElementById('info-usuari').innerHTML = `<b>ğŸ‘¤ ${nom}</b>`;
        ajustarCanvas();
        segÃ¼entParaula();
    }

    function eliminarUsuari(e, nom) {
        e.stopPropagation(); 
        if(confirm(`Vols esborrar l'usuari ${nom}?`)) {
            delete usuarios[nom];
            localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
            renderPerfils();
        }
    }

    function animarPremi() {
        const capa = document.getElementById('capa-premi');
        capa.classList.remove('animar-premi');
        void capa.offsetWidth; 
        capa.classList.add('animar-premi');
    }

    function validar(llegit) {
        if(llegit === paraulaActual.p) {
            estrellesTotals++;
            sonar(523, 0.5);
            animarPremi(); 
            avanÃ§ar();
        } else {
            intentsFallits++;
            actualitzarVides();
            sonar(150, 0.3);
            if (llegit.toLowerCase() === paraulaActual.p) alert("âš ï¸ Recorda fer-ho en MINÃšSCULES!");
            else alert(`He llegit "${llegit}"`);
            netejar();
            if (intentsFallits >= 3) { alert("Canviem de paraula!"); segÃ¼entParaula(); }
        }
    }

    async function comprovar() {
        if(traÃ§os.length === 0) return;
        const botons = document.querySelectorAll('.btn-revisar');
        botons.forEach(b => b.innerText = "...");
        
        const dades = { "options": "enable_pre_space", "requests": [{ "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height }, "ink": traÃ§os.map(t => [t.map(p => p[0]), t.map(p => p[1])]), "language": "ca" }] };
        try {
            const r = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=autotext&cs=1&oe=UTF-8', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dades)
            });
            const res = await r.json();
            if(res[0] === "SUCCESS") validar(res[1][0][1][0]);
        } catch (e) { alert("Error de connexiÃ³"); }
        botons.forEach(b => b.innerText = "Revisar ğŸ‘");
    }

    function netejar() {
        ctx.clearRect(0,0,canvas.width,canvas.height); traÃ§os = [];
        ctx.strokeStyle = '#f5f5f5'; ctx.lineWidth = 2;
        const espai = canvas.height / 4;
        [1, 2, 3].forEach(i => { ctx.beginPath(); ctx.moveTo(0, espai*i); ctx.lineTo(canvas.width, espai*i); ctx.stroke(); });
        ctx.strokeStyle = '#555'; ctx.lineWidth = 6; ctx.lineCap = 'round';
    }

    function obtenirPos(e) {
        const r = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: (t.clientX - r.left) * (canvas.width / r.width), y: (t.clientY - r.top) * (canvas.height / r.height) };
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); dibuixant = true; traÃ§Actual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); traÃ§Actual.push([Math.round(p.x), Math.round(p.y)]); });
    canvas.addEventListener('touchend', () => { if(dibuixant) traÃ§os.push(traÃ§Actual); dibuixant = false; });
    canvas.addEventListener('mousedown', (e) => { dibuixant = true; traÃ§Actual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(dibuixant) { const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); traÃ§Actual.push([Math.round(p.x), Math.round(p.y)]); } });
    window.addEventListener('mouseup', () => { if(dibuixant) traÃ§os.push(traÃ§Actual); dibuixant = false; });

    function crearUsuari() {
        const nom = document.getElementById('nou-nom').value.trim();
        if(nom && !usuarios[nom]) {
            usuarios[nom] = { nivel: 1, estrelles: 0 };
            localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
            renderPerfils();
            document.getElementById('nou-nom').value = '';
        }
    }

    function renderPerfils() {
        const c = document.getElementById('llista-perfils'); c.innerHTML = '';
        for (let n in usuarios) {
            c.innerHTML += `
                <div class="perfil-card" onclick="seleccionarUsuari('${n}')">
                    <div class="btn-eliminar" onclick="eliminarUsuari(event, '${n}')">âœ•</div>
                    ğŸ‘¤<br>${n}
                </div>`;
        }
        renderRanking();
    }

    function renderRanking() {
        const r = document.getElementById('llista-ranking'); r.innerHTML = '';
        Object.keys(usuarios).map(n=>({n, s:usuarios[n].estrelles})).sort((a,b)=>b.s-a.s).slice(0,5)
        .forEach((u,i)=> r.innerHTML += `<div style="display:flex;justify-content:space-between; margin-bottom:5px"><span>${i+1}. ${u.n}</span><span>${u.s}â­</span></div>`);
    }

    function segÃ¼entParaula() {
        if (paraulesPendents.length === 0) {
            paraulesPendents = [...baseDeDades].sort(() => Math.random() - 0.5);
        }
        paraulaActual = paraulesPendents.pop();
        intentsFallits = 0; 
        actualitzarVides();
        document.getElementById('imatge-paraula').innerText = paraulaActual.i;
        document.getElementById('nom-paraula').innerText = paraulaActual.p;
        document.getElementById('num-totals').innerText = estrellesTotals;
        renderNivells(); 
        netejar();
    }

    function actualitzarVides() { document.getElementById('contenidor-vides').innerHTML = "â¤ï¸".repeat(3-intentsFallits) + "ğŸ–¤".repeat(intentsFallits); }

    function avanÃ§ar() { 
        usuarios[usuariActiu].estrelles = estrellesTotals; 
        if(estrellesTotals > 0 && estrellesTotals % 5 === 0) {
            nivelActual++;
            usuarios[usuariActiu].nivel = nivelActual;
            setTimeout(() => {
                sonarNivell();
                const cartell = document.getElementById('cartell-nivell');
                cartell.innerText = `ğŸ‰ NIVELL ${nivelActual} ğŸ‰`;
                cartell.classList.add('show');
                setTimeout(() => cartell.classList.remove('show'), 2000);
            }, 500);
        }
        localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
        setTimeout(segÃ¼entParaula, 1000); 
    }
    
    function renderNivells() {
        const l = document.getElementById('llista-nivells'); l.innerHTML = '';
        for(let i=Math.max(1, nivelActual-2); i<=nivelActual+2; i++) {
            l.innerHTML += `<div class="nivell-item ${i===nivelActual?'actiu':(i<nivelActual?'completat':'')}">Nivell ${i}</div>`;
        }
    }

    function tornarAInici() { location.reload(); }
    window.onload = renderPerfils;
</script>
</body>
</html>