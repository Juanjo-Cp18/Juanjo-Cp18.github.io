<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lletres M√†giques PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2196f3">

    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="manifest" href='data:application/manifest+json,{"short_name":"Lletres","name":"Lletres M√†giques","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/588/588395.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}],"start_url":"index.html","display":"standalone","background_color":"#fdf6e3","theme_color":"#2196f3"}'>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root { --fons: #fdf6e3; --primari: #ff6f00; --exit: #4caf50; --error: #f44336; --cel: #2196f3; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            background-color: var(--fons); 
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
            touch-action: none; 
        }

        /* Pantalla d'Inici */
        #pantalla-usuari { 
            position: fixed; inset: 0; background: var(--cel); z-index: 100; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; color: white; overflow-y: auto; text-align: center; 
        }

        /* Estructura Principal */
        #joc-contenedor { 
            display: none; 
            flex-direction: row; 
            height: 100vh; 
            width: 100vw;
        }

        /* Panell Lateral amb Scroll */
        #panell-lateral { 
            width: 160px; 
            background: white; 
            border-right: 4px solid #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Zona de joc principal */
        #zona-principal { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        /* Adaptaci√≥ a pantalles verticals (M√≤bils de peu) */
        @media (max-aspect-ratio: 1/1) {
            #joc-contenedor { flex-direction: column; }
            #panell-lateral { width: 100%; height: 80px; flex-direction: row; border-right: none; border-bottom: 4px solid #eee; }
            #llista-nivells { display: none; }
            #info-usuari { font-size: 0.8rem; }
        }

        canvas { 
            background: white; 
            border-radius: 20px; 
            border: 4px solid var(--cel); 
            max-width: 95%; 
            max-height: 50vh;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        }

        .perfil-card { background: white; color: #333; padding: 10px; border-radius: 15px; width: 85px; cursor: pointer; margin: 5px; }
        
        #contenidor-vides { font-size: 1.5rem; margin-top: 5px; }
        
        button { cursor: pointer; border: none; border-radius: 50px; font-weight: bold; font-family: inherit; transition: transform 0.1s; }
        button:active { transform: scale(0.9); }

        .btn-accio { padding: 12px 25px; color: white; font-size: 1rem; }
        
        /* Ocultar scrollbars per√≤ mantenir funcionalitat */
        #panell-lateral::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body>

<div id="pantalla-usuari">
    <h1>Lletres M√†giques ‚úèÔ∏è</h1>
    <div style="margin-bottom: 20px;">
        <input type="text" id="nou-nom" placeholder="El teu nom..." style="padding:10px; border-radius:10px; border:none;">
        <button onclick="crearUsuari()" style="background: var(--primari); padding:10px 20px; color:white; margin-top:5px;">Afegir</button>
    </div>
    <div class="llista-perfils" id="llista-perfils" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
    <div id="ranking-container" style="margin-top:20px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 20px; width: 90%; max-width: 400px;">
        <h3>üèÜ Top R√®cords</h3>
        <div id="llista-ranking"></div>
    </div>
</div>

<div id="joc-contenedor">
    <div id="panell-lateral">
        <div id="info-usuari"></div>
        <div style="font-size: 1.2rem; margin: 5px 0;">‚≠ê <span id="num-totals">0</span></div>
        <div id="llista-nivells" style="width: 100%;"></div>
        <button onclick="tornarAInici()" style="background:#eee; padding:8px; margin-top:auto; width:100%;">Sortir</button>
    </div>

    <div id="zona-principal">
        <div id="contenidor-vides">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="targeta" style="background:white; padding:10px; border-radius:20px; text-align:center; width: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <div id="imatge-paraula" style="font-size:45px;"></div>
            <div id="nom-paraula" style="font-size:28px; font-weight:bold; border-top:2px dashed #eee;"></div>
        </div>
        
        <canvas id="pissarra"></canvas>
        
        <div style="display:flex; gap:10px; margin-bottom: 10px;">
            <button onclick="netejar()" class="btn-accio" style="background:var(--error);">Esborrar</button>
            <button id="btn-revisar" onclick="comprovar()" class="btn-accio" style="background:var(--exit);">Revisar üëç</button>
        </div>
    </div>
</div>

<script>
    // Configuraci√≥ i variables
    const baseDeDades = [
        {p: "poma", i: "üçé"}, {p: "gat", i: "üê±"}, {p: "casa", i: "üè†"}, {p: "gos", i: "üê∂"},
        {p: "sol", i: "‚òÄÔ∏è"}, {p: "pa", i: "ü•ñ"}, {p: "mar", i: "üåä"}, {p: "peu", i: "ü¶∂"},
        {p: "cotxe", i: "üöó"}, {p: "taula", i: "ü™ë"}, {p: "llapis", i: "‚úèÔ∏è"}, {p: "estel", i: "‚≠ê"},
        {p: "peix", i: "üêü"}, {p: "lluna", i: "üåô"}, {p: "arbre", i: "üå≥"}
    ];

    let usuarios = JSON.parse(localStorage.getItem('joc_v5_resp')) || {};
    let usuariActiu = null, nivelActual = 1, estrellesTotals = 0, paraulaActual = null;
    let tra√ßos = [], tra√ßActual = [], dibuixant = false, intentsFallits = 0;
    let audioCtx = null;

    const canvas = document.getElementById('pissarra');
    const ctx = canvas.getContext('2d');

    // Ajust din√†mic del canvas
    function ajustarPantalla() {
        const contenedor = document.getElementById('zona-principal');
        const ampleContenidor = contenedor.clientWidth * 0.9;
        const altContenidor = contenedor.clientHeight * 0.45;
        
        canvas.width = Math.min(ampleContenidor, 600);
        canvas.height = Math.min(altContenidor, 300);
        netejar();
    }

    window.addEventListener('resize', ajustarPantalla);

    // L√≤gica de so
    function iniciarAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function sonar(f, durada = 0.2) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + durada);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + durada);
    }

    // Joc
    function seleccionarUsuari(nom) {
        iniciarAudio();
        usuariActiu = nom; nivelActual = usuarios[nom].nivel || 1; estrellesTotals = usuarios[nom].estrelles || 0;
        document.getElementById('pantalla-usuari').style.display = 'none';
        document.getElementById('joc-contenedor').style.display = 'flex';
        document.getElementById('info-usuari').innerHTML = `<b>üë§ ${nom}</b>`;
        ajustarPantalla();
        seg√ºentParaula();
    }

    function validar(llegit) {
        if(llegit === paraulaActual.p) {
            estrellesTotals++;
            sonar(523, 0.5);
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            avan√ßar();
        } else {
            intentsFallits++;
            actualitzarVides();
            sonar(150, 0.3);
            if (llegit.toLowerCase() === paraulaActual.p) alert("‚ö†Ô∏è Usa MIN√öSCULES!");
            else alert(`He llegit "${llegit}"`);
            netejar();
            if (intentsFallits >= 3) { alert("Canviem de paraula!"); seg√ºentParaula(); }
        }
    }

    async function comprovar() {
        if(tra√ßos.length === 0) return;
        document.getElementById('btn-revisar').innerText = "...";
        const dades = { "options": "enable_pre_space", "requests": [{ "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height }, "ink": tra√ßos.map(t => [t.map(p => p[0]), t.map(p => p[1])]), "language": "ca" }] };
        try {
            const r = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=autotext&cs=1&oe=UTF-8', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dades)
            });
            const res = await r.json();
            if(res[0] === "SUCCESS") validar(res[1][0][1][0]);
        } catch (e) { alert("Error de connexi√≥"); }
        document.getElementById('btn-revisar').innerText = "Revisar üëç";
    }

    // Dibuix
    function netejar() {
        ctx.clearRect(0,0,canvas.width,canvas.height); tra√ßos = [];
        ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
        const h = canvas.height / 4;
        for(let i=1; i<=3; i++) { ctx.beginPath(); ctx.moveTo(0, h*i); ctx.lineTo(canvas.width, h*i); ctx.stroke(); }
        ctx.strokeStyle = '#333'; ctx.lineWidth = 5; ctx.lineCap = 'round';
    }

    function obtenirPos(e) {
        const r = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { x: t.clientX - r.left, y: t.clientY - r.top };
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); });
    canvas.addEventListener('touchend', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });
    // Support per ratol√≠
    canvas.addEventListener('mousedown', (e) => { dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(dibuixant) { const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); } });
    window.addEventListener('mouseup', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });

    // Gesti√≥ d'usuaris
    function crearUsuari() {
        const nom = document.getElementById('nou-nom').value.trim();
        if(nom && !usuarios[nom]) {
            usuarios[nom] = { nivel: 1, estrelles: 0, avatar: "üë§" };
            localStorage.setItem('joc_v5_resp', JSON.stringify(usuarios));
            renderPerfils();
            document.getElementById('nou-nom').value = '';
        }
    }

    function renderPerfils() {
        const c = document.getElementById('llista-perfils'); c.innerHTML = '';
        for (let n in usuarios) {
            c.innerHTML += `<div class="perfil-card" onclick="seleccionarUsuari('${n}')">üë§<br>${n}</div>`;
        }
        renderRanking();
    }

    function renderRanking() {
        const r = document.getElementById('llista-ranking'); r.innerHTML = '';
        Object.keys(usuarios).map(n=>({n, s:usuarios[n].estrelles})).sort((a,b)=>b.s-a.s).slice(0,5)
        .forEach((u,i)=> r.innerHTML += `<div style="display:flex;justify-content:space-between"><span>${i+1}. ${u.n}</span><span>${u.s}‚≠ê</span></div>`);
    }

    function seg√ºentParaula() {
        paraulaActual = baseDeDades[Math.floor(Math.random()*baseDeDades.length)];
        intentsFallits = 0; actualitzarVides();
        document.getElementById('imatge-paraula').innerText = paraulaActual.i;
        document.getElementById('nom-paraula').innerText = paraulaActual.p;
        document.getElementById('num-totals').innerText = estrellesTotals;
        renderNivells(); netejar();
    }

    function actualitzarVides() { document.getElementById('contenidor-vides').innerHTML = "‚ù§Ô∏è".repeat(3-intentsFallits) + "üñ§".repeat(intentsFallits); }
    function avan√ßar() { 
        usuarios[usuariActiu].estrelles = estrellesTotals; 
        if(estrellesTotals%5===0) nivelActual++; 
        usuarios[usuariActiu].nivel = nivelActual;
        localStorage.setItem('joc_v5_resp', JSON.stringify(usuarios));
        seg√ºentParaula(); 
    }
    
    function renderNivells() {
        const l = document.getElementById('llista-nivells'); l.innerHTML = '';
        for(let i=Math.max(1, nivelActual-1); i<=nivelActual+1; i++) {
            l.innerHTML += `<div class="nivell-item ${i===nivelActual?'actiu':(i<nivelActual?'completat':'')}">Nivell ${i}</div>`;
        }
    }

    function tornarAInici() { location.reload(); }
    window.onload = renderPerfils;
</script>
</body>
</html>