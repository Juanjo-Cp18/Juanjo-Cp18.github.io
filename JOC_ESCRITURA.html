<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lletres M√†giques PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --fons: #fdf6e3; --primari: #ff6f00; --exit: #4caf50; --error: #f44336; --cel: #2196f3; }
        body { margin: 0; background-color: var(--fons); font-family: 'Comic Sans MS', cursive, sans-serif; overflow: hidden; touch-action: none; }
        
        /* Pantalla d'Inici */
        #pantalla-usuari { position: fixed; inset: 0; background: var(--cel); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; color: white; overflow-y: auto; padding: 20px; }
        .llista-perfils { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .perfil-card { background: white; color: #333; padding: 15px; border-radius: 20px; text-align: center; width: 100px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; transition: transform 0.2s; }
        .perfil-card:active { transform: scale(0.95); }
        .perfil-avatar { font-size: 40px; }
        .btn-eliminar { position: absolute; top: -5px; right: -5px; background: var(--error); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; }
        
        #ranking-container { margin-top: 30px; background: rgba(255,255,255,0.15); padding: 20px; border-radius: 20px; width: 90%; max-width: 400px; border: 2px dashed rgba(255,255,255,0.5); }
        
        /* Joc */
        #joc-contenedor { display: none; flex-direction: row; height: 100vh; }
        #panell-lateral { width: 150px; background: white; border-right: 4px solid #eee; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        #zona-principal { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-around; padding: 10px; }
        #canvas-contenedor { background: white; border-radius: 25px; border: 4px solid var(--cel); position: relative; }
        canvas { display: block; border-radius: 25px; cursor: crosshair; }
        
        #contenidor-vides { font-size: 1.8rem; margin-bottom: 5px; letter-spacing: 5px; }
        .nivell-item { padding: 8px; margin: 4px; border-radius: 10px; font-size: 0.8rem; width: 90%; text-align: center; background: #eee; color: #999; }
        .nivell-item.actiu { background: var(--primari); color: white; font-weight: bold; }
        .nivell-item.completat { background: var(--exit); color: white; }
        
        button { cursor: pointer; border: none; transition: transform 0.1s; }
        button:active { transform: scale(0.9); }
    </style>
</head>
<body>

<div id="pantalla-usuari">
    <h1>Lletres M√†giques ‚úèÔ∏è</h1>
    <div style="margin-bottom: 20px;">
        <input type="text" id="nou-nom" placeholder="El teu nom..." style="padding: 12px; border-radius: 15px; border: none; width: 180px; font-family: inherit;">
        <button onclick="sonar('clic'); crearUsuari()" style="background: var(--primari); padding:12px; border-radius:15px; color:white; font-weight:bold;">Afegir</button>
    </div>
    <div class="llista-perfils" id="llista-perfils"></div>
    <div id="ranking-container">
        <h2 style="margin: 0 0 15px 0; text-align: center;">üèÜ Top 5 R√®cords</h2>
        <div id="llista-ranking"></div>
    </div>
</div>

<div id="joc-contenedor">
    <div id="panell-lateral">
        <div id="info-usuari" style="font-weight: bold; color: var(--cel); text-align: center; margin-bottom: 10px;"></div>
        <div style="font-size: 1.5rem;">‚≠ê <span id="num-totals">0</span></div>
        <div id="llista-nivells" style="width: 100%; margin-top: 15px;"></div>
        <button onclick="sonar('clic'); tornarAInici()" style="background:#eee; padding:10px; border-radius:10px; margin-top:auto; font-size:0.7rem; width:100%;">Sortir</button>
    </div>

    <div id="zona-principal">
        <div id="contenidor-vides">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="targeta" style="background:white; padding:20px; border-radius:25px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.1); width: 260px;">
            <div id="imatge-paraula" style="font-size:70px;"></div>
            <div id="nom-paraula" style="font-size:38px; font-weight:bold; border-top:2px dashed #eee; color: #333;"></div>
        </div>
        <div id="canvas-contenedor"><canvas id="pissarra"></canvas></div>
        <div style="display:flex; gap:15px;">
            <button onclick="sonar('clic'); netejar()" style="background:#f44336; color:white; padding:15px 25px; border-radius:50px; font-weight:bold;">Esborrar</button>
            <button id="btn-revisar" onclick="sonar('clic'); comprovar()" style="background:#4caf50; color:white; padding:15px 35px; border-radius:50px; font-weight:bold; font-size:1.2rem;">Revisar üëç</button>
        </div>
    </div>
</div>

<script>
    const baseDeDades = [
        {p: "poma", i: "üçé"}, {p: "gat", i: "üê±"}, {p: "casa", i: "üè†"}, {p: "gos", i: "üê∂"},
        {p: "sol", i: "‚òÄÔ∏è"}, {p: "pa", i: "ü•ñ"}, {p: "mar", i: "üåä"}, {p: "peu", i: "ü¶∂"},
        {p: "cotxe", i: "üöó"}, {p: "taula", i: "ü™ë"}, {p: "llapis", i: "‚úèÔ∏è"}, {p: "estel", i: "‚≠ê"},
        {p: "peix", i: "üêü"}, {p: "lluna", i: "üåô"}, {p: "arbre", i: "üå≥"}, {p: "llimona", i: "üçã"},
        {p: "bicicleta", i: "üö≤"}, {p: "elefant", i: "üêò"}, {p: "papallona", i: "ü¶ã"}, 
        {p: "ordinador", i: "üíª"}, {p: "formatge", i: "üßÄ"}, {p: "esquirol", i: "üêøÔ∏è"},
        {p: "caramel", i: "üç¨"}, {p: "ra√Øm", i: "üçá"}, {p: "col¬∑legi", i: "üè´"}
    ];

    const animals = ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ", "ü¶Å", "üêÆ", "üê∑", "üê∏", "üêµ"];
    let usuarios = JSON.parse(localStorage.getItem('joc_vFinal_pro')) || {};
    let usuariActiu = null, nivelActual, estrellesTotals, paraulaActual, tra√ßos = [], tra√ßActual = [], dibuixant = false;
    let paraulesRecents = [], intentsFallits = 0;

    const canvas = document.getElementById('pissarra');
    const ctx = canvas.getContext('2d');

    // --- MOTOR DE SONS (Sintetitzats) ---
    function sonar(tipus) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);

        const ara = audioCtx.currentTime;
        if (tipus === 'clic') {
            osc.frequency.setValueAtTime(400, ara);
            gain.gain.setValueAtTime(0.1, ara);
            gain.gain.exponentialRampToValueAtTime(0.01, ara + 0.1);
            osc.start(); osc.stop(ara + 0.1);
        } else if (tipus === 'error') {
            osc.frequency.setValueAtTime(150, ara);
            osc.type = 'sawtooth';
            gain.gain.setValueAtTime(0.1, ara);
            gain.gain.linearRampToValueAtTime(0, ara + 0.3);
            osc.start(); osc.stop(ara + 0.3);
        } else if (tipus === 'victoria') {
            const notes = [261, 329, 392, 523];
            notes.forEach((f, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.frequency.setValueAtTime(f, ara + (i * 0.1));
                g.gain.setValueAtTime(0.1, ara + (i * 0.1));
                g.gain.exponentialRampToValueAtTime(0.01, ara + (i * 0.1) + 0.4);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(ara + (i * 0.1)); o.stop(ara + (i * 0.1) + 0.4);
            });
        } else if (tipus === 'puf') {
            osc.frequency.exponentialRampToValueAtTime(50, ara + 0.3);
            gain.gain.setValueAtTime(0.1, ara);
            osc.start(); osc.stop(ara + 0.3);
        }
    }

    // --- L√íGICA VISUAL ---
    function actualitzarVides() {
        const v = 3 - intentsFallits;
        document.getElementById('contenidor-vides').innerHTML = "‚ù§Ô∏è".repeat(v) + "üñ§".repeat(intentsFallits);
    }

    function actualitzarRanking() {
        const cont = document.getElementById('llista-ranking');
        cont.innerHTML = '';
        const llista = Object.keys(usuarios).map(n => ({nom:n, ...usuarios[n]})).sort((a,b) => b.estrelles - a.estrelles).slice(0, 5);
        llista.forEach((u, i) => {
            const div = document.createElement('div');
            div.style = "display:flex; justify-content:space-between; background:white; color:#333; padding:8px 15px; border-radius:10px; margin-bottom:5px; font-weight:bold;";
            div.innerHTML = `<span>${i+1}. ${u.avatar} ${u.nom}</span><span>${u.estrelles} ‚≠ê</span>`;
            cont.appendChild(div);
        });
    }

    function renderPerfils() {
        const cont = document.getElementById('llista-perfils');
        cont.innerHTML = '';
        for (let nom in usuarios) {
            const card = document.createElement('div');
            card.className = 'perfil-card';
            card.innerHTML = `<button class="btn-eliminar" onclick="event.stopPropagation(); sonar('error'); eliminarUsuari('${nom}')">√ó</button>
                <div onclick="sonar('clic'); seleccionarUsuari('${nom}')"><div class="perfil-avatar">${usuarios[nom].avatar}</div><div style="font-weight:bold">${nom}</div></div>`;
            cont.appendChild(card);
        }
        actualitzarRanking();
    }

    // --- L√íGICA DE JOC ---
    function seg√ºentParaula() {
        let filtrades = [];
        if (nivelActual <= 20) filtrades = baseDeDades.filter(w => w.p.length <= 4);
        else if (nivelActual <= 50) filtrades = baseDeDades.filter(w => w.p.length > 4 && w.p.length <= 6);
        else filtrades = baseDeDades.filter(w => w.p.length > 6 || w.p.includes('¬∑'));

        let opcions = filtrades.filter(w => !paraulesRecents.includes(w.p));
        if (opcions.length === 0) { paraulesRecents = []; opcions = filtrades; }

        paraulaActual = opcions[Math.floor(Math.random() * opcions.length)];
        paraulesRecents.push(paraulaActual.p);
        if (paraulesRecents.length > 6) paraulesRecents.shift();

        intentsFallits = 0;
        actualitzarVides();
        document.getElementById('imatge-paraula').innerText = paraulaActual.i;
        document.getElementById('nom-paraula').innerText = paraulaActual.p;
        document.getElementById('num-totals').innerText = estrellesTotals;
        renderNivells();
        netejar();
    }

    function validar(llegit) {
        if(llegit.toLowerCase() === paraulaActual.p.toLowerCase()) {
            estrellesTotals++;
            sonar('victoria');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.7 } });
            avan√ßar();
        } else {
            intentsFallits++;
            actualitzarVides();
            if (intentsFallits >= 3) {
                sonar('puf');
                alert("‚ö†Ô∏è No passa res! Provem una altra paraula.");
                seg√ºentParaula();
            } else {
                sonar('error');
                alert(`He llegit "${llegit}". Torna-ho a provar!`);
                netejar();
            }
        }
    }

    async function comprovar() {
        if(tra√ßos.length === 0) return;
        const btn = document.getElementById('btn-revisar');
        btn.innerText = "...";
        const dades = { "options": "enable_pre_space", "requests": [{ "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height }, "ink": tra√ßos.map(t => [t.map(p => p[0]), t.map(p => p[1])]), "language": "ca" }] };
        try {
            const resp = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=autotext&cs=1&oe=UTF-8', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dades)
            });
            const res = await resp.json();
            if(res[0] === "SUCCESS") validar(res[1][0][1][0]);
        } catch (e) { alert("Error de connexi√≥."); }
        btn.innerText = "Revisar üëç";
    }

    function avan√ßar() {
        usuarios[usuariActiu].estrelles = estrellesTotals;
        if (estrellesTotals % 5 === 0) { nivelActual++; usuarios[usuariActiu].nivel = nivelActual; }
        guardar();
        if (nivelActual > 100) { alert("üèÜ Incre√Øble! Ets un mestre!"); tornarAInici(); }
        else seg√ºentParaula();
    }

    // --- CANVAS I INTERF√çCIE ---
    function netejar() {
        ctx.clearRect(0,0,canvas.width,canvas.height); tra√ßos = [];
        ctx.strokeStyle = '#eee'; ctx.lineWidth = 2;
        [75, 150, 225].forEach(y => { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); });
        ctx.strokeStyle = '#333'; ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    }

    function obtenirPos(e) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
    }

    canvas.addEventListener('mousedown', (e) => { dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(!dibuixant) return; const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); });
    window.addEventListener('mouseup', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); });
    canvas.addEventListener('touchend', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });

    function seleccionarUsuari(nom) {
        usuariActiu = nom; nivelActual = usuarios[nom].nivel || 1; estrellesTotals = usuarios[nom].estrelles || 0;
        document.getElementById('pantalla-usuari').style.display = 'none';
        document.getElementById('joc-contenedor').style.display = 'flex';
        document.getElementById('info-usuari').innerHTML = `${usuarios[nom].avatar}<br>${nom}`;
        ajustarCanvas(); seg√ºentParaula();
    }

    function crearUsuari() {
        const nom = document.getElementById('nou-nom').value.trim();
        if(nom && !usuarios[nom]) {
            usuarios[nom] = { nivel: 1, estrelles: 0, avatar: animals[Math.floor(Math.random()*animals.length)] };
            guardar(); renderPerfils(); document.getElementById('nou-nom').value = '';
        }
    }

    function eliminarUsuari(n) { if(confirm(`Eliminar ${n}?`)) { delete usuarios[n]; guardar(); renderPerfils(); } }
    function guardar() { localStorage.setItem('joc_vFinal_pro', JSON.stringify(usuarios)); }
    function tornarAInici() { location.reload(); }
    function ajustarCanvas() { canvas.width = Math.min(window.innerWidth * 0.7, 700); canvas.height = 300; netejar(); }

    function renderNivells() {
        const llista = document.getElementById('llista-nivells'); llista.innerHTML = '';
        let inici = Math.max(1, nivelActual - 4);
        for(let i=inici; i<=nivelActual + 4; i++) {
            if(i > 100) break;
            const div = document.createElement('div');
            div.className = `nivell-item ${i < nivelActual ? 'completat' : (i === nivelActual ? 'actiu' : '')}`;
            div.innerText = "Nivell " + i; llista.appendChild(div);
        }
    }

    window.onload = renderPerfils;
</script>
</body>
</html>