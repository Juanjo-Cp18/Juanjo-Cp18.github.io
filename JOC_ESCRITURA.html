<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Lletres M√†giques PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#a2d2ff">

    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/588/588395.png">

    <style>
        :root { 
            --fons: #fefaf0; 
            --primari: #ffb07c; 
            --exit: #b9fbc0; 
            --error: #ffcfd2; 
            --cel: #a2d2ff; 
            --text: #555;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body { 
            margin: 0; padding: 0;
            background-color: var(--fons); 
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            min-height: 100%;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        #pantalla-usuari { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 30px 20px; color: white; background: var(--cel);
            min-height: 100vh; text-align: center;
        }

        #joc-contenedor { display: none; flex-direction: row; min-height: 100vh; }

        #panell-lateral { 
            width: 180px; background: white; border-right: 4px solid #f0f0f0; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px 10px; flex-shrink: 0;
        }

        #zona-principal { 
            flex-grow: 1; display: flex; flex-direction: column; 
            align-items: center; padding: 15px; gap: 10px; width: 100%;
        }

        @media (max-width: 850px) {
            #joc-contenedor { flex-direction: column; }
            #panell-lateral { 
                width: 100%; flex-direction: row; justify-content: space-around; 
                border-right: none; border-bottom: 4px solid #f0f0f0;
                padding: 10px; position: sticky; top: 0; z-index: 10;
            }
            #llista-nivells { display: none; }
        }

        canvas { 
            background: white; border-radius: 20px; border: 4px solid var(--cel); 
            max-width: 95vw; height: auto;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05); 
            touch-action: none; 
        }

        #capa-premi {
            position: fixed; inset: 0; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; opacity: 0; font-size: 6rem;
        }
        .animar-premi { animation: popEstrella 1.2s ease-out forwards; }
        @keyframes popEstrella {
            0% { transform: scale(0.2); opacity: 0; }
            20% { opacity: 1; transform: scale(1.5); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: translateY(-200px); }
        }

        .perfil-card { 
            background: white; color: var(--text); padding: 15px; border-radius: 15px; 
            width: 110px; cursor: pointer; margin: 10px; text-align: center; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative;
        }
        
        .btn-eliminar {
            position: absolute; top: -5px; right: -5px;
            background: var(--error); color: #8b3a3a; border-radius: 50%;
            width: 25px; height: 25px; display: flex; align-items: center;
            justify-content: center; font-size: 12px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nivell-item { padding: 8px; margin: 4px; border-radius: 10px; font-size: 0.8rem; width: 90%; text-align: center; background: #f9f9f9; color: #888; }
        .nivell-item.actiu { background: var(--primari); color: white; }
        .nivell-item.completat { background: var(--exit); color: #2d5a27; }

        button { cursor: pointer; border: none; border-radius: 50px; font-weight: bold; font-family: inherit; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-accio { padding: 15px 30px; color: var(--text); font-size: 1.1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.05); }
        
        input { padding: 12px; border-radius: 12px; border: none; width: 150px; outline: none; font-family: inherit; }

        .credits { font-size: 10px; opacity: 0.7; margin-top: 30px; color: #fff; }
    </style>
</head>
<body>

<div id="capa-premi">üåü</div>

<div id="pantalla-usuari">
    <h1>Lletres M√†giques ‚úèÔ∏è</h1>
    <div style="margin-bottom: 25px;">
        <input type="text" id="nou-nom" placeholder="El teu nom...">
        <button onclick="crearUsuari()" style="background: var(--primari); padding:12px 20px; color:white;">Afegir</button>
    </div>
    <div class="llista-perfils" id="llista-perfils" style="display:flex; flex-wrap:wrap; justify-content:center; width: 100%;"></div>
    
    <div id="ranking-container" style="width: 100%; max-width: 400px; margin-top: 20px; background: rgba(255,255,255,0.3); padding: 15px; border-radius: 20px; color: #555;">
        <h3 style="margin:0">üèÜ Millors R√®cords</h3>
        <div id="llista-ranking"></div>
    </div>

    <div class="credits">Ha estat ideat per Juanjo</div>
</div>

<div id="joc-contenedor">
    <div id="panell-lateral">
        <div id="info-usuari" style="color: var(--text);"></div>
        <div style="font-size: 1.5rem; margin: 10px 0;">‚≠ê <span id="num-totals">0</span></div>
        <div id="llista-nivells" style="width: 100%;"></div>
        <button onclick="tornarAInici()" style="background:#f0f0f0; color:#888; padding:8px; margin-top:auto; width:100%; border-radius: 10px;">Sortir</button>
    </div>

    <div id="zona-principal">
        <div id="contenidor-vides" style="font-size: 1.8rem;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        <div id="targeta" style="background:white; padding:15px; border-radius:25px; text-align:center; min-width: 200px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 3px solid #fff;">
            <div id="imatge-paraula" style="font-size:50px;"></div>
            <div id="nom-paraula" style="font-size:30px; font-weight:bold; border-top:2px dashed #f0f0f0; color: #444;"></div>
        </div>
        
        <canvas id="pissarra"></canvas>
        
        <div style="display:flex; gap:15px; margin: 10px 0;">
            <button onclick="netejar()" class="btn-accio" style="background:var(--error); color: #8b3a3a;">Esborrar</button>
            <button id="btn-revisar" onclick="comprovar()" class="btn-accio" style="background:var(--exit); color: #2d5a27;">Revisar üëç</button>
        </div>
    </div>
</div>

<script>
    const baseDeDades = [
        {p: "poma", i: "üçé"}, {p: "gat", i: "üê±"}, {p: "casa", i: "üè†"}, {p: "gos", i: "üê∂"},
        {p: "sol", i: "‚òÄÔ∏è"}, {p: "pa", i: "ü•ñ"}, {p: "mar", i: "üåä"}, {p: "peu", i: "ü¶∂"},
        {p: "cotxe", i: "üöó"}, {p: "taula", i: "ü™ë"}, {p: "llapis", i: "‚úèÔ∏è"}, {p: "estel", i: "‚≠ê"},
        {p: "peix", i: "üêü"}, {p: "lluna", i: "üåô"}, {p: "arbre", i: "üå≥"}
    ];

    let usuarios = JSON.parse(localStorage.getItem('joc_v6_final')) || {};
    let usuariActiu = null, nivelActual = 1, estrellesTotals = 0, paraulaActual = null;
    let tra√ßos = [], tra√ßActual = [], dibuixant = false, intentsFallits = 0;
    let audioCtx = null;

    const canvas = document.getElementById('pissarra');
    const ctx = canvas.getContext('2d');

    function ajustarCanvas() {
        const ampleMax = Math.min(window.innerWidth - 40, 600);
        const alturaDisponible = window.innerHeight - (window.innerWidth < 850 ? 280 : 380);
        canvas.width = ampleMax;
        canvas.height = Math.max(250, Math.min(350, alturaDisponible)); 
        netejar();
    }

    window.addEventListener('resize', ajustarCanvas);
    window.addEventListener('orientationchange', () => setTimeout(ajustarCanvas, 300));

    function iniciarAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function sonar(f, durada = 0.2) {
        if (!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + durada);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + durada);
    }

    function seleccionarUsuari(nom) {
        iniciarAudio();
        usuariActiu = nom; nivelActual = usuarios[nom].nivel || 1; estrellesTotals = usuarios[nom].estrelles || 0;
        document.getElementById('pantalla-usuari').style.display = 'none';
        document.getElementById('joc-contenedor').style.display = 'flex';
        document.getElementById('info-usuari').innerHTML = `<b>üë§ ${nom}</b>`;
        ajustarCanvas();
        seg√ºentParaula();
    }

    function eliminarUsuari(e, nom) {
        e.stopPropagation(); // Evita que s'activi la selecci√≥ d'usuari
        if(confirm(`Vols esborrar l'usuari ${nom}?`)) {
            delete usuarios[nom];
            localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
            renderPerfils();
        }
    }

    function animarPremi() {
        const capa = document.getElementById('capa-premi');
        capa.classList.remove('animar-premi');
        void capa.offsetWidth; 
        capa.classList.add('animar-premi');
    }

    function validar(llegit) {
        if(llegit === paraulaActual.p) {
            estrellesTotals++;
            sonar(523, 0.5);
            animarPremi(); 
            avan√ßar();
        } else {
            intentsFallits++;
            actualitzarVides();
            sonar(150, 0.3);
            if (llegit.toLowerCase() === paraulaActual.p) alert("‚ö†Ô∏è Recorda fer-ho en MIN√öSCULES!");
            else alert(`He llegit "${llegit}"`);
            netejar();
            if (intentsFallits >= 3) { alert("Canviem de paraula!"); seg√ºentParaula(); }
        }
    }

    async function comprovar() {
        if(tra√ßos.length === 0) return;
        const btn = document.getElementById('btn-revisar');
        btn.innerText = "...";
        
        const dades = { 
            "options": "enable_pre_space", 
            "requests": [{ 
                "writing_guide": { "writing_area_width": canvas.width, "writing_area_height": canvas.height }, 
                "ink": tra√ßos.map(t => [t.map(p => p[0]), t.map(p => p[1])]), 
                "language": "ca" 
            }] 
        };

        try {
            const r = await fetch('https://www.google.com.tw/inputtools/request?ime=handwriting&app=autotext&cs=1&oe=UTF-8', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dades)
            });
            const res = await r.json();
            if(res[0] === "SUCCESS") validar(res[1][0][1][0]);
        } catch (e) { alert("Error de connexi√≥"); }
        btn.innerText = "Revisar üëç";
    }

    function netejar() {
        ctx.clearRect(0,0,canvas.width,canvas.height); tra√ßos = [];
        ctx.strokeStyle = '#f5f5f5'; ctx.lineWidth = 2;
        const espai = canvas.height / 4;
        [1, 2, 3].forEach(i => { ctx.beginPath(); ctx.moveTo(0, espai*i); ctx.lineTo(canvas.width, espai*i); ctx.stroke(); });
        ctx.strokeStyle = '#555'; ctx.lineWidth = 6; ctx.lineCap = 'round';
    }

    function obtenirPos(e) {
        const r = canvas.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return { 
            x: (t.clientX - r.left) * (canvas.width / r.width), 
            y: (t.clientY - r.top) * (canvas.height / r.height) 
        };
    }

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); });
    canvas.addEventListener('touchend', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });
    canvas.addEventListener('mousedown', (e) => { dibuixant = true; tra√ßActual = []; const p = obtenirPos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); });
    canvas.addEventListener('mousemove', (e) => { if(dibuixant) { const p = obtenirPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); tra√ßActual.push([Math.round(p.x), Math.round(p.y)]); } });
    window.addEventListener('mouseup', () => { if(dibuixant) tra√ßos.push(tra√ßActual); dibuixant = false; });

    function crearUsuari() {
        const nom = document.getElementById('nou-nom').value.trim();
        if(nom && !usuarios[nom]) {
            usuarios[nom] = { nivel: 1, estrelles: 0 };
            localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
            renderPerfils();
            document.getElementById('nou-nom').value = '';
        }
    }

    function renderPerfils() {
        const c = document.getElementById('llista-perfils'); c.innerHTML = '';
        for (let n in usuarios) {
            c.innerHTML += `
                <div class="perfil-card" onclick="seleccionarUsuari('${n}')">
                    <div class="btn-eliminar" onclick="eliminarUsuari(event, '${n}')">‚úï</div>
                    üë§<br>${n}
                </div>`;
        }
        renderRanking();
    }

    function renderRanking() {
        const r = document.getElementById('llista-ranking'); r.innerHTML = '';
        Object.keys(usuarios).map(n=>({n, s:usuarios[n].estrelles})).sort((a,b)=>b.s-a.s).slice(0,5)
        .forEach((u,i)=> r.innerHTML += `<div style="display:flex;justify-content:space-between; margin-bottom:5px"><span>${i+1}. ${u.n}</span><span>${u.s}‚≠ê</span></div>`);
    }

    function seg√ºentParaula() {
        paraulaActual = baseDeDades[Math.floor(Math.random()*baseDeDades.length)];
        intentsFallits = 0; actualitzarVides();
        document.getElementById('imatge-paraula').innerText = paraulaActual.i;
        document.getElementById('nom-paraula').innerText = paraulaActual.p;
        document.getElementById('num-totals').innerText = estrellesTotals;
        renderNivells(); netejar();
    }

    function actualitzarVides() { document.getElementById('contenidor-vides').innerHTML = "‚ù§Ô∏è".repeat(3-intentsFallits) + "üñ§".repeat(intentsFallits); }
    function avan√ßar() { 
        usuarios[usuariActiu].estrelles = estrellesTotals; 
        if(estrellesTotals%5===0) nivelActual++; 
        usuarios[usuariActiu].nivel = nivelActual;
        localStorage.setItem('joc_v6_final', JSON.stringify(usuarios));
        setTimeout(seg√ºentParaula, 1000); 
    }
    
    function renderNivells() {
        const l = document.getElementById('llista-nivells'); l.innerHTML = '';
        for(let i=Math.max(1, nivelActual-2); i<=nivelActual+2; i++) {
            l.innerHTML += `<div class="nivell-item ${i===nivelActual?'actiu':(i<nivelActual?'completat':'')}">Nivell ${i}</div>`;
        }
    }

    function tornarAInici() { location.reload(); }
    window.onload = renderPerfils;
</script>
</body>
</html>