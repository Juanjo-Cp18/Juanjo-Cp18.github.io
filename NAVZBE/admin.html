<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>NavAdmin - Gesti√≥n de Tr√°fico</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FF9800">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="./style.css">

    <style>
        /* Admin specific adjustments */
        .admin-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 3000;
            pointer-events: none;
        }

        .controls {
            background: rgba(255, 152, 0, 0.25) !important;
        }
    </style>
</head>

<body class="admin-mode">
    <div class="admin-header">MODO ADMINISTRADOR</div>
    <img id="city-crest" src="./soller_crest.svg" alt="Escudo S√≥ller">
    <div id="map"></div>

    <!-- GPS Status (Top Center) -->
    <div id="status-pill">...</div>
    <div id="status" class="hidden"></div>

    <!-- UI Controls Sidebar (Unified Admin Panel) -->
    <div class="controls" id="main-controls">
        <div id="admin-controls">
            <!-- General Map Controls -->
            <button id="center-btn" title="Centrar Mapa" onclick="centerMap()"
                style="background-color: #2196F3;">üéØ</button>
            <button id="ui-toggle-btn" onclick="toggleUI()" title="Ocultar Iconos"
                style="background-color: #fff; color: #444;">üëÅÔ∏è</button>
            <button id="help-btn" title="Ayuda / Ajuda" onclick="openHelpModal()"
                style="background-color: #2196F3;">‚ùì</button>

            <div class="separator"></div>

            <!-- Admin Logic Controls -->
            <button id="btn-pause-gps" title="Pausar GPS" onclick="toggleAdminGPS()"
                style="background-color: #607D8B;">üìç</button>
            <button id="refresh-btn" title="Refrescar Se√±ales" onclick="refreshRules()"
                style="background-color: #4CAF50;">üîÑ</button>
            <button title="Importar OSM" onclick="importOSMRules()" style="background-color: #FF9800;">üåç</button>
            <button title="Cargar rules.js" onclick="resetRulesFromFile()"
                style="background-color: #9C27B0;">üîÑ</button>
            <button title="Descargar Config" onclick="downloadConfig()" style="background-color: #2196F3;">üíæ</button>
            <button title="Borrar Todo" onclick="clearAllRules()" style="background-color: #f44336;">üóëÔ∏è</button>
            <button id="sim-toggle-btn" onclick="toggleSimulation()" title="Modo Simulaci√≥n"
                style="background-color: #ffc107; color: #333;">üéÆ</button>
        </div>
    </div>

    <!-- Admin: Rule Creation Modal -->
    <div id="rule-modal" class="hidden">
        <div class="modal-content">
            <h3>A√±adir Regla de Tr√°fico</h3>
            <select id="rule-type">
                <option value="forbidden">‚õî Direcci√≥n Prohibida</option>
                <option value="mandatory">‚¨áÔ∏è Direcci√≥n Obligatoria</option>
            </select>
            <div class="direction-inputs">
                <p>Direcci√≥n (Rumbo): <span id="angle-display">0</span>¬∞</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <input type="range" id="rule-angle" min="0" max="360" value="0" oninput="updateAnglePreview()">
                    <div id="angle-preview"
                        style="width: 30px; height: 30px; border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #eee;">
                        <div id="angle-arrow" style="font-size: 20px; font-weight: bold; transform-origin: center;">
                            ‚¨ÜÔ∏è
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="saveRule()" style="background-color: #4CAF50;">‚úÖ Guardar</button>
                <button onclick="closeModal()" style="background-color: #777;">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden">
        <div class="modal-content help-content">
            <div class="help-scroll-area">
                <div class="help-lang-section">
                    <h3>‚ÑπÔ∏è Ajuda / Informaci√≥n</h3>
                    <p><b>CATAL√Ä</b></p>
                    <p>Aquest √©s un prototip de navegaci√≥. Pot presentar errors. Cal respectar sempre la senyalitzaci√≥
                        vi√†ria existent. Circuli amb precauci√≥.</p>
                    <p><b>Requisits:</b> Cal tenir activada la <b>Ubicaci√≥</b> del tel√®fon i la <b>Precisi√≥ de la
                            ubicaci√≥</b>.</p>
                    <p><b>Instal¬∑laci√≥:</b></p>
                    <ul>
                        <li><b>iOS (iPhone):</b> Prem 'Compartir' ‚éã i 'Afegir a la pantalla d'inici' ‚äû.</li>
                        <li><b>Android:</b> Prem els tres punts ‚ãÆ i 'Instal¬∑lar aplicaci√≥' o 'Afegir a pantalla inici'.
                        </li>
                    </ul>

                    <hr>

                    <p><b>ESPA√ëOL</b></p>
                    <p>Este es un prototipo de navegaci√≥n. Puede presentar errores. Se debe respetar siempre la
                        se√±alizaci√≥n viaria existente. Circule con precauci√≥n.</p>
                    <p><b>Requisitos:</b> Debe estar activada la <b>Ubicaci√≥n</b> del tel√©fono y la <b>Precisi√≥n de la
                            ubicaci√≥n</b>.</p>
                    <p><b>Instalaci√≥n:</b></p>
                    <ul>
                        <li><b>iOS (iPhone):</b> Pulsa 'Compartir' ‚éã y 'A√±adir a la pantalla de inicio' ‚äû.</li>
                        <li><b>Android:</b> Pulsa los tres puntos ‚ãÆ e 'Instalar aplicaci√≥n' o 'A√±adir a pantalla
                            inicio'.</li>
                    </ul>
                </div>
            </div>
            <button onclick="closeHelpModal()" class="close-btn">Tancar / Cerrar</button>
        </div>
    </div>

    <!-- Simulation Keypad (Separate from toggle) -->
    <div id="simulation-controls" class="hidden">
        <div id="sim-keypad" class="hidden">
            <div class="sim-row">
                <button class="sim-btn" data-dir="up-left">‚Üñ</button>
                <button class="sim-btn" data-dir="up">‚ñ≤</button>
                <button class="sim-btn" data-dir="up-right">‚Üó</button>
            </div>
            <div class="sim-row">
                <button class="sim-btn" data-dir="left">‚óÄ</button>
                <button onclick="stopSimulated()" style="background:#f44336">‚úñ</button>
                <button class="sim-btn" data-dir="right">‚ñ∂</button>
            </div>
            <div class="sim-row">
                <button class="sim-btn" data-dir="down-left">‚Üô</button>
                <button class="sim-btn" data-dir="down">‚ñº</button>
                <button class="sim-btn" data-dir="down-right">‚Üò</button>
            </div>
        </div>
    </div>

    <!-- Scrolling Ticker -->
    <div id="ticker-container">
        <div id="ticker-text">
            Reforma circulat√≤ria de S√≥ller - 27/02/2026 - ASISTENT DE CIRCULACI√ì - Prototip de navegaci√≥, circuli amb
            precauci√≥.
        </div>
    </div>

    <!-- Version Info -->
    <div id="version-label">Versi√≥n: 1.32</div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Global Configuration -->
    <script>
        window.isAplicationAdmin = true;
    </script>

    <!-- Firebase SDK (Lite via CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // This will be accessible from app.js once loaded
        window.FirebaseSDK = { initializeApp, getDatabase, ref, set, onValue };

        // Signal Firebase readiness if app.js is already waiting
        if (window.onFirebaseSDKLoaded) window.onFirebaseSDKLoaded();
    </script>

    <script src="./rules.js"></script>
    <script src="./app.js"></script>
</body>

</html>