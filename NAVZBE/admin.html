<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>NavAdmin - GestiÃ³n de TrÃ¡fico</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#FF9800">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script>
        (function () {
            const v = new URLSearchParams(window.location.search).get('v') || '1.44';
            document.write('<link rel="stylesheet" href="./style.css?v=' + v + '">');
        })();
    </script>

    <style>
        /* Admin specific adjustments */
        .admin-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 152, 0, 0.9);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            z-index: 3000;
            pointer-events: none;
        }

        .controls {
            background: rgba(255, 152, 0, 0.25) !important;
        }
    </style>
</head>

<body class="admin-mode">
    <div class="admin-header">MODE ADMINISTRADOR</div>
    <img id="city-crest" src="./soller_crest.svg" alt="Escudo SÃ³ller">
    <div id="map"></div>

    <!-- GPS Status (Top Center) -->
    <div id="status-pill">...</div>

    <!-- UI Controls Sidebar (Unified Admin Panel) -->
    <div class="controls" id="main-controls">
        <div id="admin-controls">
            <!-- General Map Controls -->
            <button id="center-btn" title="Centrar Mapa" onclick="centerMap()"
                style="background-color: #2196F3;">ğŸ¯</button>
            <button id="ui-toggle-btn" onclick="toggleUI()" title="Ocultar Iconos"
                style="background-color: #fff; color: #444;">ğŸ‘ï¸</button>
            <button id="help-btn" title="Ayuda / Ajuda" onclick="openHelpModal()"
                style="background-color: #2196F3;">â“</button>

            <div class="separator"></div>

            <!-- Admin Logic Controls -->
            <button id="btn-pause-gps" title="Pausar GPS" onclick="toggleAdminGPS()"
                style="background-color: #607D8B;">ğŸ“</button>
            <button id="refresh-btn" title="Refrescar Senyals" onclick="refreshRules()"
                style="background-color: #4CAF50;">ğŸ”„</button>
            <button title="Importar OSM" onclick="importOSMRules()" style="background-color: #FF9800;">ğŸŒ</button>
            <button title="Cargar rules.js" onclick="resetRulesFromFile()"
                style="background-color: #9C27B0;">ğŸ”„</button>
            <button title="Descargar Config" onclick="downloadConfig()" style="background-color: #2196F3;">ğŸ’¾</button>
            <button title="Borrar Todo" onclick="clearAllRules()" style="background-color: #f44336;">ğŸ—‘ï¸</button>
            <button id="sim-toggle-btn" onclick="toggleSimulation()" title="Modo SimulaciÃ³n"
                style="background-color: #ffc107; color: #333;">ğŸ®</button>
            <div class="separator"></div>
            <button id="overlay-mode-btn" onclick="toggleOverlayMode()" title="Modo Capa Visual (Tapar Flechas)"
                style="background-color: #673AB7;">ğŸ¨</button>
            <button title="Recargar overlays.js" onclick="resetOverlaysFromFile()"
                style="background-color: #4b2c85;">ğŸ”„</button>
            <button title="Descargar Overlays" onclick="downloadOverlaysConfig()"
                style="background-color: #5e35b1;">ğŸ’¾</button>
        </div>
    </div>

    <!-- Admin: Overlay Creation Modal -->
    <div id="overlay-modal" class="hidden">
        <div class="modal-content" style="border-top: 5px solid #673AB7;">
            <h3>Afegir Fletxa Visual</h3>
            <p><small>Aquesta fletxa nomÃ©s serveix per corregir el mapa visualment. No activarÃ  alarmes.</small></p>
            <div class="direction-inputs">
                <p>DirecciÃ³ (Rumb): <span id="overlay-angle-display">0</span>Â°</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <input type="range" id="overlay-angle" min="0" max="360" value="0"
                        oninput="updateOverlayAnglePreview()">
                    <div id="overlay-angle-preview"
                        style="width: 35px; height: 35px; border: 2px solid #673AB7; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #fff;">
                        <div id="overlay-angle-arrow"
                            style="font-size: 24px; font-weight: bold; transform-origin: center; color: #673AB7;">
                            â†‘
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="saveOverlay()" style="background-color: #673AB7;">âœ… ColÂ·locar</button>
                <button onclick="closeOverlayModal()" style="background-color: #777;">âŒ CancelÂ·lar</button>
            </div>
        </div>
    </div>

    <!-- Admin: Rule Creation Modal -->
    <div id="rule-modal" class="hidden">
        <div class="modal-content">
            <h3>Afegir Regla de TrÃ nsit</h3>
            <select id="rule-type">
                <option value="forbidden">â›” DirecciÃ³ Prohibida</option>
                <option value="mandatory">â¬‡ï¸ DirecciÃ³ ObligatÃ²ria</option>
            </select>
            <div class="direction-inputs">
                <p>DirecciÃ³ (Rumb): <span id="angle-display">0</span>Â°</p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <input type="range" id="rule-angle" min="0" max="360" value="0" oninput="updateAnglePreview()">
                    <div id="angle-preview"
                        style="width: 30px; height: 30px; border: 2px solid #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; background: #eee;">
                        <div id="angle-arrow" style="font-size: 20px; font-weight: bold; transform-origin: center;">
                            â¬†ï¸
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="saveRule()" style="background-color: #4CAF50;">âœ… Desar</button>
                <button onclick="closeModal()" style="background-color: #777;">âŒ CancelÂ·lar</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden">
        <div class="modal-content help-content">
            <div class="help-scroll-area">
                <div class="help-lang-section">
                    <h3>â„¹ï¸ Ajuda / InformaciÃ³n</h3>
                    <p><b>CATALÃ€</b></p>
                    <p>Aquest Ã©s un prototip de navegaciÃ³. Pot presentar errors. Cal respectar sempre la senyalitzaciÃ³
                        viÃ ria existent. Circuli amb precauciÃ³.</p>
                    <p><b>Requisits:</b> Cal tenir activada la <b>UbicaciÃ³</b> del telÃ¨fon i la <b>PrecisiÃ³ de la
                            ubicaciÃ³</b>.</p>
                    <p><b>InstalÂ·laciÃ³:</b></p>
                    <ul>
                        <li><b>iOS (iPhone):</b> Prem 'Compartir' â‹ i 'Afegir a la pantalla d'inici' âŠ.</li>
                        <li><b>Android:</b> Prem els tres punts â‹® i 'InstalÂ·lar aplicaciÃ³' o 'Afegir a pantalla inici'.
                        </li>
                    </ul>

                    <hr>

                    <p><b>ESPAÃ‘OL</b></p>
                    <p>Este es un prototipo de navegaciÃ³n. Puede presentar errores. Se debe respetar siempre la
                        seÃ±alizaciÃ³n viaria existente. Circule con precauciÃ³n.</p>
                    <p><b>Requisitos:</b> Debe estar activada la <b>UbicaciÃ³n</b> del telÃ©fono y la <b>PrecisiÃ³n de la
                            ubicaciÃ³n</b>.</p>
                    <p><b>InstalaciÃ³n:</b></p>
                    <ul>
                        <li><b>iOS (iPhone):</b> Pulsa 'Compartir' â‹ y 'AÃ±adir a la pantalla de inicio' âŠ.</li>
                        <li><b>Android:</b> Pulsa los tres puntos â‹® e 'Instalar aplicaciÃ³n' o 'AÃ±adir a pantalla
                            inicio'.</li>
                    </ul>
                </div>
            </div>
            <button onclick="closeHelpModal()" class="close-btn">Tancar / Cerrar</button>
        </div>
    </div>

    <!-- Simulation Keypad (Separate from toggle) -->
    <div id="simulation-controls" class="hidden">
        <div id="sim-keypad" class="hidden">
            <div class="sim-row">
                <button class="sim-btn" data-dir="up-left">â†–</button>
                <button class="sim-btn" data-dir="up">â–²</button>
                <button class="sim-btn" data-dir="up-right">â†—</button>
            </div>
            <div class="sim-row">
                <button class="sim-btn" data-dir="left">â—€</button>
                <button onclick="stopSimulated()" style="background:#f44336">âœ–</button>
                <button class="sim-btn" data-dir="right">â–¶</button>
            </div>
            <div class="sim-row">
                <button class="sim-btn" data-dir="down-left">â†™</button>
                <button class="sim-btn" data-dir="down">â–¼</button>
                <button class="sim-btn" data-dir="down-right">â†˜</button>
            </div>
        </div>
    </div>

    <!-- Scrolling Ticker -->
    <div id="ticker-container">
        <div id="ticker-text">
            Reforma circulatÃ²ria de SÃ³ller - 27/02/2026 - ASISTENT DE CIRCULACIÃ“ - Prototip de navegaciÃ³, circuli amb
            precauciÃ³.
        </div>
    </div>

    <!-- Version Info -->
    <div id="version-label">VersiÃ³: 1.44</div>



    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Global Configuration -->
    <script>
        window.isApplicationAdmin = true;
    </script>

    <!-- Firebase SDK (Lite via CDN) -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // This will be accessible from app.js once loaded
        window.FirebaseSDK = { initializeApp, getApps, getDatabase, ref, set, onValue };

        // Signal Firebase readiness if app.js is already waiting
        if (window.onFirebaseSDKLoaded) window.onFirebaseSDKLoaded();
    </script>


    <script>
        (function () {
            const v = new URLSearchParams(window.location.search).get('v') || '1.44';
            const scripts = ['./rules.js', './overlays.js', './app.js'];
            scripts.forEach(src => {
                document.write('<script src="' + src + '?v=' + v + '"><\/script>');
            });
        })();
    </script>
</body>

</html>