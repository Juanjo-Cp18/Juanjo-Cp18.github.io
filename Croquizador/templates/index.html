<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Mapa a Inkscape</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .mono {
            font-family: 'Roboto Mono', monospace;
        }

        /* A4 Landscape Aspect Ratio Fix: 
           A4 is 297mm x 210mm (Ratio 1.414). 
           We use a fixed size that matches this ratio approximately.
           Width: 707px, Height: 500px.
        */
        #map-container {
            width: 100%;
            display: flex;
            justify-content: center;
            background: #cbd5e1;
            padding: 10px;
            border-radius: 0.5rem;
            overflow: auto;
            /* Allow scroll if screen is small */
        }

        #map {
            width: 707px;
            height: 500px;
            flex-shrink: 0;
            border: 2px solid #334155;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .tech-panel {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-modern {
            transition: all 0.2s;
        }

        .btn-modern:hover {
            transform: translateY(-1px);
        }

        .btn-modern:active {
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-slate-100 p-6 min-h-screen text-slate-800">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- Header / Controls (Left Column) -->
        <div class="lg:col-span-4 space-y-4">
            <div class="tech-panel p-6 rounded-xl">
                <div class="mb-6 border-b pb-4 text-center">
                    <img src="/static/logo.png" alt="Anagrama" class="h-16 mx-auto mb-2 object-contain">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Oficial A500015</p>
                    <h2 class="text-lg font-bold text-slate-800">Plano para Croquis</h2>
                    <p class="text-[0.65rem] text-slate-400 mt-1">Fuente Cartogr√°fica: Sede Electr√≥nica del Catastro</p>
                </div>

                <!-- Search Section -->
                <div class="space-y-3 mb-6">
                    <label class="block text-xs font-bold uppercase text-slate-500">Ubicaci√≥n</label>

                    <!-- Town Input -->
                    <input type="text" id="town" value="S√≥ller" placeholder="Municipio" onchange="searchTownOnly()"
                        class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm font-semibold text-slate-700 mb-1">

                    <!-- Street Input with Dynamic Datalist -->
                    <input type="text" id="street" list="streets-list" oninput="autocompleteStreets()"
                        placeholder="Calle (Empieza a escribir...)"
                        class="w-full p-2.5 bg-slate-50 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                    <datalist id="streets-list">
                        <!-- Populated via JS -->
                    </datalist>

                    <div class="flex gap-2">
                        <input type="text" id="numbers" placeholder="N¬∫"
                            class="w-1/3 p-2.5 bg-slate-50 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        <button onclick="searchLocation()"
                            class="btn-modern flex-1 bg-blue-600 text-white font-semibold py-2 rounded hover:bg-blue-700 shadow-sm text-sm">
                            Buscar üîç
                        </button>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="space-y-3 mb-6 border-t pt-4 border-slate-100">
                    <label class="block text-xs font-bold uppercase text-slate-500">Configuraci√≥n de Mapa</label>
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Estilo Visual</label>
                        <select id="mapStyle" onchange="changeMapStyle()"
                            class="w-full p-2 border border-slate-300 rounded bg-white text-sm">
                            <option value="catastro" selected>Catastro (Oficial)</option>
                            <option value="osm">Est√°ndar (Color)</option>
                            <option value="carto">T√©cnico (Escala de Grises)</option>
                            <option value="esri">Sat√©lite (Fotograf√≠a)</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-slate-700">Escala Aproximada (1:X)</label>
                        <div class="flex gap-2">
                            <input type="number" id="scaleInput" value="200"
                                class="w-24 p-2 border border-slate-300 rounded text-sm mono" min="50" max="5000">
                            <button onclick="applyScale()"
                                class="btn-modern bg-slate-200 text-slate-700 px-3 py-1 rounded text-xs font-bold hover:bg-slate-300 uppercase tracking-wide">
                                Aplicar Zoom
                            </button>
                        </div>
                        <p class="text-xs text-slate-400">Ajusta el nivel de zoom para aproximar la escala visual.</p>
                    </div>
                </div>

                <!-- File Section -->
                <div class="pt-4 border-t border-slate-100">
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-3">Exportaci√≥n</label>

                    <div class="mb-4">
                        <p class="text-xs text-slate-500 mb-1">Archivo de destino:</p>
                        <p
                            class="font-mono text-sm font-bold text-slate-800 bg-slate-100 p-2 rounded border border-slate-200">
                            PLANIFICADOR.svg</p>
                    </div>

                    <button onclick="processMap()" id="processBtn"
                        class="btn-modern w-full bg-emerald-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-emerald-700 shadow-md uppercase tracking-wide transition-colors">
                        Capturar e Insertar en PLANIFICADOR.svg
                    </button>
                    <div id="status" class="mt-3 text-xs text-center font-mono font-medium min-h-[1.5em]"></div>

                    <div class="flex gap-2 mt-2">
                        <button onclick="openCapturesFolder()"
                            class="flex-1 btn-modern bg-slate-200 text-slate-700 py-2 rounded-lg font-bold text-xs hover:bg-slate-300 border border-slate-300">
                            üìÇ Capturas
                        </button>
                        <button onclick="document.getElementById('helpModal').classList.remove('hidden')"
                            class="flex-1 btn-modern bg-slate-200 text-slate-700 py-2 rounded-lg font-bold text-xs hover:bg-slate-300 border border-slate-300">
                            ‚ùì Ayuda
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Area (Right Column) -->
        <div class="lg:col-span-8">
            <div id="map-container">
                <div id="map"></div>
            </div>
            <div class="mt-2 text-xs text-slate-500 flex justify-between items-center px-1">
                <span>üìç Coordenadas: <span id="coordsDisplay" class="mono">--</span></span>
                <span>Proyecci√≥n: EPSG:3857 (Web Mercator)</span>
            </div>
        </div>

    </div>

    <!-- Help Modal (Professional Design) -->
    <div id="helpModal"
        class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[9999] flex items-center justify-center p-4 transition-opacity duration-300">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col overflow-hidden animate-in fade-in zoom-in duration-200 ring-1 ring-slate-900/5">

            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">Gu√≠a del Croquizador</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Manual R√°pido de Uso</p>
                    </div>
                </div>
                <button onclick="document.getElementById('helpModal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full p-2 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Body -->
            <div class="p-8 overflow-y-auto bg-slate-50/50">

                <!-- Process Steps Grid -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">

                    <!-- Step 1 -->
                    <div
                        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                        <div
                            class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 font-bold mb-4">
                            1</div>
                        <h4 class="font-bold text-slate-900 mb-2">Buscar Ubicaci√≥n</h4>
                        <p class="text-sm text-slate-600 leading-relaxed mb-3">Introduce Municipio, Calle y N√∫mero.
                            Pulsa <span class="font-bold text-slate-800">Buscar</span>.</p>
                        <div class="bg-slate-50 p-2 rounded text-xs text-slate-500 border border-slate-100">
                            <strong>Nota:</strong> Si no encuentra el n√∫mero exacto, te situar√° en el centro de la
                            calle.
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="bg-white p-5 rounded-xl border border-blue-200 shadow-md ring-2 ring-blue-50 relative">
                        <div
                            class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-[0.6rem] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">
                            Importante</div>
                        <div
                            class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-700 font-bold mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122">
                                </path>
                            </svg>
                        </div>
                        <h4 class="font-bold text-slate-900 mb-2">Correcci√≥n Manual</h4>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            Si el punto no es exacto, haz clic en el marcador azul y <strong>arr√°stralo</strong> sin
                            soltar hasta la ubicaci√≥n precisa (casa, cruce, etc.).
                        </p>
                    </div>

                    <!-- Step 3 -->
                    <div
                        class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                        <div
                            class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 font-bold mb-4">
                            3</div>
                        <h4 class="font-bold text-slate-900 mb-2">Exportar</h4>
                        <p class="text-sm text-slate-600 leading-relaxed mb-2">Selecciona tu archivo SVG y ajusta el
                            zoom.</p>
                        <p class="text-sm text-slate-600 leading-relaxed">
                            Pulsa <strong>Capturar</strong>. El programa insertar√° el mapa limpio en Inkscape.
                        </p>
                    </div>
                </div>

                <!-- Troubleshooting -->
                <div class="bg-slate-100 rounded-xl p-5 border border-slate-200">
                    <h5 class="font-bold text-slate-700 text-sm flex items-center gap-2 mb-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                            </path>
                        </svg>
                        Soluci√≥n de Problemas
                    </h5>
                    <ul class="text-xs text-slate-600 space-y-1 list-disc list-inside">
                        <li>Aseg√∫rate de tener conexi√≥n a Internet para ver el mapa.</li>
                        <li>Si necesitas forzar el cierre, usa el archivo <code>stop.bat</code> en la carpeta.</li>
                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="document.getElementById('helpModal').classList.add('hidden')"
                    class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold text-sm shadow-sm transition-all hover:translate-y-px">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-simple-map-screenshoter"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>

    <script src="/static/js/app.js"></script>
</body>

</html>